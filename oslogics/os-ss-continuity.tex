% !TEX root = ../main.tex

Recall from Chapter~\ref{chap:sub} that a formula $\varphi \in \llang(A)$ is continuous in $\{\vlist{a}\} \subseteq A$ if $\varphi$ is monotone in $\vlist{a}$ and additionally, for every $(D,\val)$ and assignment $\ass:\fovar\to D$,
\[
\text{if } (D,\val),\ass \models \varphi \text{ then } \exists \vlist{U} \subseteq_\omega \val(\vlist{a}) \text{ such that } (D, \val[\vlist{a} \mapsto \vlist{U}]),\ass \models \varphi.
\]

\begin{remark}\label{rem:contprodeach}
	It was proved in Proposition~\ref{prop:contiffpcont} that continuity in the product coincides with continuity in every variable. Therefore, in the following proofs we will, in general, consider continuity in every single $a_i$ instead of in the full $\vlist{a}$. This is equivalent, and only done to avoid an even more complex notation.
\end{remark}

In this section we will characterize the continuous fragment of $\ofo$ and $\ofoei$ but we will not characterize that of $\ofoe$, since it is not used in this dissertation.
% It will be useful to give a syntactic characterization of continuity for several one-step logics.

%%
\subsubsection{Continuous fragment of $\ofo$}

\index{fragment!continuous!$\ofo$}
\index{$\ofo$!$\cont{}{A'}$}
\begin{theorem}\label{thm:ofocont}
A formula of $\ofo(A)$ is continuous in $A' \subseteq A$ iff it is equivalent to a sentence given by:
\[
\varphi ::= \psi \mid a(x) \mid \exists x.\varphi \mid \varphi \land \varphi \mid \varphi \lor \varphi
\]
where $a\in A'$ and $\psi \in \ofo(A\setminus A')$. We denote this fragment as $\cont{\ofo}{A'}(A)$.
\end{theorem}
%
The theorem will follow from the next two lemmas and Remark~\ref{rem:contprodeach}.

\begin{lemma}\label{lem:cofoiscont}
Every $\varphi \in \cont{\ofo}{a}(A)$ is continuous in $a$.
\end{lemma}
\begin{proof}
First observe that $\varphi$ is monotone in $a$ by Theorem~\ref{thm:ofomonot}.
We show, by induction, that any one-step formula $\varphi$ in the fragment (which may not be a sentence) satisfies, for every one-step model $(D,\val)$, assignment ${\ass:\fovar\to D}$,
%
\[
\text{if } (D,\val),\ass \models \varphi \text{ then } \exists U \subseteq_\omega \val(a) \text{ such that } (D,\val[a\mapsto U]),\ass \models \varphi.
\]
%
\begin{enumerate}[\textbullet]
\item If ${\varphi = \psi \in \ofo(A\setminus \{a\})}$ changes in the $a$ part of the valuation will make no difference and hence the condition is trivial. 

\item Case $\varphi = a(x)$: if $(D,\val),\ass \models a(x)$ then $\ass(x)\in \val(a)$. Clearly, $\ass(x) \in \val[a\mapsto \{\ass(x)\}](a)$ and hence $(D, \val[a\mapsto \{\ass(x)\}]),\ass \models a(x)$. %For the other direction assume $U \subseteq_\omega \val(a)$ and $(D, \val[a\mapsto U]),\ass \models a(x)$. This means that $\ass(x) \in U \subseteq \val(a)$, hence $(D, \val),\ass \models a(x)$.

\item Case $\varphi = \varphi_1 \lor \varphi_2$: assume $(D,\val),\ass \models \varphi$. Without loss of generality we can assume that $(D,\val),\ass \models \varphi_1$ and hence by induction hypothesis we have that there is $U \subseteq_\omega \val(a)$ such that $(D,\val[a\mapsto U]),\ass \models \varphi_1$ which clearly implies $(D,\val[a\mapsto U]),\ass \models \varphi$. %For the other direction let $U \subseteq_\omega \val(a)$ and assume wlog that $(D,\val[a\mapsto U]),\ass \models \varphi_1$. By induction hypothesis $(D,\val),\ass \models \varphi_1$ which entails $(D,\val),\ass \models \varphi$.

\item Case $\varphi = \varphi_1 \land \varphi_2$: assume $(D,\val),\ass \models \varphi$. By induction hypothesis we have $U_1,U_2 \subseteq_\omega \val(a)$ such that $(D,\val[a\mapsto U_1]),\ass \models \varphi_1$ and $(D,\val[a\mapsto U_2]),\ass \models \varphi_2$. By monotonicity this also holds with $\val[a\mapsto U_1 \cup U_2]$ and therefore $(D,\val[a\mapsto U_1 \cup U_2]),\ass \models \varphi$. %The other direction is very similar to the case of disjunction.

\item Case $\varphi = \exists x.\varphi'(x)$ and $(D,\val),\ass \models \varphi$. By definition there exists $d\in D$ such that $(D,\val),\ass[x\mapsto d] \models \varphi'(x)$. By induction hypothesis there exists $U \subseteq_\omega \val(a)$ such that $(D,\val[a\mapsto U]),\ass[x\mapsto d] \models \varphi'(x)$ and hence $(D,\val[a\mapsto U]),\ass \models \exists x.\varphi'(x)$.
% \item Case $\varphi = \exists x.\varphi'(x)$ and $(D,\val),\ass \models \varphi$. This occurs iff there exists $d\in D$ such that $(D,\val),\ass[x\mapsto d] \models \varphi'(x)$. By induction hypothesis this is equivalent to $\exists U \subseteq_\omega \val(a)$ such that $(D,\val[a\mapsto U]),\ass[x\mapsto d] \models \varphi'(x)$ which holds iff $(D,\val[a\mapsto U]),\ass \models \exists x.\varphi'(x)$.
\end{enumerate}
This finishes the proof.
\end{proof}

\begin{lemma}
There is a translation $(-)^\tcont:\monot{\ofo}{a}(A) \to \cont{\ofo}{a}(A)$ such that
a formula ${\varphi \in \monot{\ofo}{a}(A)}$ is continuous in $a$ if and only if $\varphi\equiv \varphi^\tcont$.
\end{lemma}
\begin{proof}
To define the translation we assume, without loss of generality, that $\varphi$ is in the basic form $\bigvee \mondbnfofo{\Sigma}{a}$.
% where
% %
% \[
% \mondbnfofo{\Sigma}{a} := \bigwedge_{S\in\Sigma} \exists x. \tau^a_S(x) \land \forall x. \bigvee_{S\in\Sigma} \tau^a_S(x).
% \]
%
For the translation, let
$(\bigvee \mondbnfofo{\Sigma}{a})^\tcont := \bigvee \mondgbnfofo{\Sigma}{\Sigma^{-}_{a}}{a}$
where
%
% \[
% \mondgbnfofo{\Sigma}{\Pi}{a} := \bigwedge_{S\in\Sigma} \exists x. \tau^a_S(x) \land \forall x. \bigvee_{S\in\Pi} \tau^a_S(x)
% \]
%
% and
$\Sigma^{-}_{a} := \{S\in \Sigma \mid a\notin S\}$.
%Intuitively, the translation says that we should be able to divide the description given by $\dbnfofo{\Sigma}$ in two parts: (1) $\nabla^{-}_p(\Gamma)$ gives a complete (existential and universal) description with respect to colours which are not $a$ and (2) an existential description where $a$ can only appear as a positive constraint.

\bigskip
From the construction it is clear that $\varphi^\tcont \in \cont{\ofo}{a}(A)$ and therefore the right-to-left direction of the lemma is immediate by Lemma~\ref{lem:cofoiscont}. For the left-to-right direction assume that $\varphi$ is continuous in $a$, we have to prove that $(D,\val) \models \varphi$ iff $(D,\val) \models \varphi^\tcont$, for every one-step model $(D,\val)$. We will take a slightly different but equivalent approach.

It is easy to prove that $(D,\val) \equiv_\fo (D\times \omega,\val_\pi)$ where $D\times\omega$ has countably many copies of each element in $D$ and $\val_\pi(a) := \{(d,k) \mid d\in \val(a), k\in\omega\}$.
%
Moreover, as $\varphi$ is continuous in $a$ there is $U \subseteq_\omega \val_\pi(a)$ such that $\val'_\pi := \val[a \mapsto U]$ satisfies $(D\times\omega,\val_\pi) \models \varphi$ iff $(D\times\omega,\val'_\pi) \models \varphi$.
%
Therefore, it is enough to prove that $(D\times\omega,\val'_\pi) \models \varphi$ iff $(D\times\omega,\val'_\pi) \models \varphi^\tcont$. % Assume again that $\varphi = \bigvee \dbnfofo{\Sigma}$.

\bigskip
\noindent \fbox{$\Rightarrow$}
Let $(D\times\omega,\val'_\pi) \models \mondbnfofo{\Sigma}{a}$, we show that $(D\times\omega,\val'_\pi) \models \mondgbnfofo{\Sigma}{\Sigma^{-}_{a}}{a}$. The existential part of $\mondgbnfofo{\Sigma}{\Sigma^{-}_{a}}{a}$ is trivially true. We have to show that every element of $(D\times\omega,\val'_\pi)$ realizes an $a$-positive type in $\Sigma^{-}_{a}$. Take $(d,k) \in D\times\omega$ and let $T$ be the (full) type of $(d,k)$. If $a\notin T$ then trivially $T\in \Sigma^{-}_{a}$ and we are done. Suppose $a\in T$. Observe that in $D\times\omega$ we have infinitely many copies of $d\in D$. However, as $\val'_\pi(a)$ is finite, there must be some $(d,k')$ with type $T' := T\setminus\{a\}$.
%\fcwarning{Write better}
For $\mondbnfofo{\Sigma}{a}$ to be true we must have $T'\in \Sigma$ and hence $T'\in \Sigma^{-}_{a}$. It is easy to see that $(d,k)$ realizes the $a$-positive type $T'$.

\bigskip
\noindent \fbox{$\Leftarrow$}
Let $(D\times\omega,\val'_\pi) \models \mondgbnfofo{\Sigma}{\Sigma^{-}_{a}}{a}$, we show that $(D\times\omega,\val'_\pi) \models \mondbnfofo{\Sigma}{a}$. The existential part is trivial. For the universal part just observe that $\Sigma^{-}_{a} \subseteq \Sigma$.
\end{proof}

Putting together the above lemmas we obtain Theorem~\ref{thm:ofocont}. Moreover, a careful analysis of the translation gives us the following corollary, providing normal forms for the continuous fragment of $\ofo$.

\begin{corollary}\label{cor:ofocontinuousnf}
	Let $\varphi \in \ofo(A)$, the following hold:
	\begin{enumerate}[(i)]
		\item The formula $\varphi$ is continuous in $a \in A$ iff it is equivalent to a formula $\bigvee \mondgbnfofo{\Sigma}{\Sigma^{-}_{a}}{a}$ for some types $\Sigma \subseteq \wp A$, where $\Sigma^{-}_{a} := \{S\in \Sigma \mid a\notin S\}$.
		%
		\item If $\varphi$ is monotone in $A$ (i.e., $\varphi\in\ofo^+(A)$) then $\varphi$ is continuous in $a \in A$ iff it is equivalent to a formula in the basic form $\bigvee \posdgbnfofo{\Sigma}{\Sigma^{-}_{a}}$ for some types $\Sigma \subseteq \wp A$, where $\Sigma^{-}_{a} := \{S\in \Sigma \mid a\notin S\}$.
	\end{enumerate}
\end{corollary}

%%
\subsubsection{Continuous fragment of $\ofoei$}

\index{fragment!continuous!$\ofoei$}
\index{$\ofoei$!$\cont{}{A'}$}
\begin{theorem}\label{thm:ofoeicont}
A formula of $\ofoei(A)$ is continuous in $ A' \subseteq A$ iff it is equivalent to a sentence given by:
\[
\varphi ::= \psi \mid a(x) \mid \exists x.\varphi \mid \varphi \land \varphi \mid \varphi \lor \varphi \mid \wqu x.(\varphi,\psi)
\]
where $a\in A'$ and $\psi \in \ofoei(A\setminus A')$. Recall from Definition~\ref{def:contmufoei} that $\wqu x.(\varphi,\psi)$ is defined as $\forall x.(\varphi(x) \lor \psi(x)) \land \dqu x.\psi(x)$. We denote this fragment as $\cont{\ofoei}{A'}(A)$.
\end{theorem}

\noindent The theorem will follow from the next two lemmas and Remark~\ref{rem:contprodeach}.

\begin{lemma}\label{lem:cofoeiiscont}
Every $\varphi \in \cont{\ofoei}{a}(A)$ is continuous in $a$.
\end{lemma}
\begin{proof}
Observe that monotonicity of $\varphi$ is guaranteed by Theorem~\ref{thm:ofoeimonot}.
We show, by induction, that any formula of the fragment (which may not be a sentence) satisfies, for every one-step model $(D,\val)$ and assignment ${\ass:\fovar\to D}$,
%
\[
\text{if } (D,\val),\ass \models \varphi \text{ then } \exists U \subseteq_\omega \val(a) \text{ such that } (D,\val[a\mapsto U]),\ass \models \varphi.
\]
%
We focus on the inductive case of the new quantifier. Let $\varphi' = \wqu x.(\varphi,\psi)$, i.e., %In other words,
%
\[\varphi' = \forall x.\underbrace{(\varphi(x) \lor \psi(x))}_{\alpha(x)} \land \underbrace{\dqu x.\psi(x)}_\beta.\]
%
Let $(D,\val),\ass \models \varphi'$. By induction hypothesis,
for every $\ass_d := \ass[x\mapsto d]$ which satisfies $(D,\val),\ass_d \models \alpha(x)$ there is $U_d \subseteq_\omega \val(a)$ such that $(D,\val[a\mapsto U_d]),\ass_d \models \alpha(x)$. The crucial observation is that because of $\beta$, %part of $\varphi'$ we know that
only finitely many elements of $d$ make $\psi(d)$ false. Let $U := \bigcup \{U_d \mid (D,\val), \ass_d \not\models \psi(x) \}$. Note that $U$ is a finite union of finite sets, hence finite.
%
\begin{claimfirst}
	Let $\val_U := \val[a\mapsto U]$; then we have $(D,\val_U),\ass \models \varphi'$.
\end{claimfirst}
%
\begin{pfclaim}
	It is clear that $(D,\val_U),\ass \models \beta$ because $\psi$ is $a$-free. To show that the first conjunct is true we have to show that $(D,\val_U),\ass_d \models \varphi(x) \lor \psi(x)$ for every $d\in D$. We consider two cases: (i) if $(D,\val),\ass_d \models \psi(x)$ we are done, again because $\psi$ is $a$-free; (ii) if the former is not the case then $U_d \subseteq U$; moreover, we knew that $(D,\val[a\mapsto U_d]),\ass_d \models \alpha(x)$ and by monotonicity of $\alpha(x)$ we can conclude that $(D,\val_U),\ass_d \models \alpha(x)$.
\end{pfclaim}
%
This finishes the proof of the lemma.
\end{proof}



\begin{lemma}\label{lem:ofoeictrans}
	There is a translation $(-)^\tcont:\monot{\ofoei}{a}(A) \to \cont{\ofoei}{a}(A)$ such that
a formula $\varphi \in \monot{\ofoei}{a}(A)$ is continuous in $a$ if and only if $\varphi\equiv \varphi^\tcont$.
\end{lemma}
\begin{proof} We assume that $\varphi$ is in basic normal form, i.e., $\varphi = \bigvee \mondbnfofoei{\vlist{T}}{\Pi}{\Sigma}{a}$.
% where
% \[
% \mondbnfofoei{\vlist{T}}{\Pi}{\Sigma}{a} = \mondbnfoe{\vlist{T}}{\Pi \cup \Sigma}{a} \land
% \bigwedge_{S\in\Sigma} \qu y.\tau^a_S(y) \land \dqu y.\bigvee_{S\in\Sigma} \tau^a_S(y) .
% \]
For the translation let $(\bigvee \mondbnfofoei{\vlist{T}}{\Pi}{\Sigma}{a})^\tcont := \bigvee \mondbnfofoei{\vlist{T}}{\Pi}{\Sigma}{a}^\tcont$ where
\[
\mondbnfofoei{\vlist{T}}{\Pi}{\Sigma}{a}^\tcont :=
\begin{cases}
	\bot &\text{ if } a\in \bigcup \Sigma\\
	\mondbnfofoei{\vlist{T}}{\Pi}{\Sigma}{a} &\text{ otherwise}.
\end{cases}
\]

First we prove the right-to-left direction of the lemma. By Lemma~\ref{lem:cofoeiiscont} it is enough to show that $\varphi^\tcont \in \cont{\ofoei}{a}(A)$. We focus on the disjuncts of $\varphi^\tcont$. The interesting case is when $a\notin \bigcup \Sigma$. If we rearrange $\mondbnfofoei{\vlist{T}}{\Pi}{\Sigma}{a}$ and define the formulas $\varphi', \psi$ as follows:
%
\begin{align*}
\mondbnfofoei{\vlist{T}}{\Pi}{\Sigma}{a} \equiv \exists \vlist{x}.\Big(& \arediff{\vlist{x}} \land \bigwedge_i \tau^a_{T_i}(x_i)\ \land \\
& \forall z.(\underbrace{\lnot\arediff{\vlist{x},z} \lor \bigvee_{S\in \Pi} \tau^a_S(z)}_{\varphi'(\vlist{x},z)} \lor \underbrace{\bigvee_{S\in \Sigma} \tau^a_S(z)}_{\psi(z)})\ \land \\
& \dqu y.\underbrace{\bigvee_{S\in\Sigma} \tau^a_S(y)}_{\psi(y)} \Big) \land \bigwedge_{S\in\Sigma} \qu y.\tau^a_S(y),
\end{align*}
%
then we get that
{\small
\[
\mondbnfofoei{\vlist{T}}{\Pi}{\Sigma}{a} \equiv \exists \vlist{x}.\Big(\arediff{\vlist{x}} \land \bigwedge_i \tau^a_{T_i}(x_i) \land \wqu z.(\varphi'(\vlist{x},z),\psi(z)) \Big) \land \bigwedge_{S\in\Sigma} \qu y.\tau^a_S(y)
\]}
%
which, because $a\notin \bigcup \Sigma$, is in the required fragment.

For the left-to-right direction of the lemma we have to prove that $\varphi \equiv \varphi^\tcont$.

\bigskip
\noindent\fbox{$\Leftarrow$} Let $(D,\val) \models \varphi^\tcont$. The only difference between $\varphi$ and $\varphi^\tcont$ is that some disjuncts may have been replaced by $\bot$. Therefore this direction is trivial.

\bigskip
\noindent\fbox{$\Rightarrow$} Let $(D,\val) \models \varphi$. Because $\varphi$ is continuous in $a$ we may assume that $\val(a)$ is finite. Let $\mondbnfofoei{\vlist{T}}{\Pi}{\Sigma}{a}$ be a disjunct of $\varphi$ such that $(D,\val) \models \mondbnfofoei{\vlist{T}}{\Pi}{\Sigma}{a}$. If $a \notin \bigcup\Sigma$ we trivially conclude that $(D,\val) \models \varphi^\tcont$ because the disjunct remains unchanged. Suppose now that $a\in \bigcup\Sigma$, then there must be some $S\in\Sigma$ with $a\in S$. Because $(D,\val) \models \mondbnfofoei{\vlist{T}}{\Pi}{\Sigma}{a}$ we have, in particular, that $(D,\val) \models \qu y.\tau^a_S(x)$ and hence $\val(a)$ must be infinite which is absurd.
\end{proof}

Putting together the above lemmas we obtain Theorem~\ref{thm:ofoeicont}. Moreover, a careful analysis of the translation gives us the following corollary, providing normal forms for the continuous fragment of $\ofoei$.

\begin{corollary}\label{cor:ofoeicontinuousnf}
Let $\varphi \in \ofoei(A)$, the following hold:
	\begin{enumerate}[(i)]
		\item The formula $\varphi$ is continuous in $a \in A$ iff it is equivalent to a formula in the basic form $\bigvee \mondbnfofoei{\vlist{T}}{\Pi}{\Sigma}{a}$ for some types $\Sigma\subseteq\Pi \subseteq \wp A$ and $T_i \subseteq A$ such that $a\notin \bigcup\Sigma$.
		%
		\item If $\varphi$ is monotone in every element of $A$ (i.e., $\varphi\in{\ofoei}^+(A)$) then $\varphi$ is continuous in $a \in A$ iff it is equivalent to a formula in the basic form $\bigvee \posdbnfofoei{\vlist{T}}{\Pi}{\Sigma}$ for some types $\Sigma\subseteq\Pi \subseteq \wp A$ and $T_i \subseteq A$ such that $a\notin \bigcup\Sigma$.
	\end{enumerate}
\end{corollary}
\begin{proof}
	We only remark that to obtain $\Sigma\subseteq\Pi$ in the above normal forms it is enough to use Proposition~\ref{prop:bfofoei-sigmapi} before applying the translation.
\end{proof}
