% !TEX root = main-wmso.tex
\subsection{Automata and formulas}

\btbs
\item
Generally it is well-known that there are effective translations from automata
to formulas and vice versa.
\item
In this subsection we focus on the following theorem.
\etbs


\begin{theorem}\label{t:autofor}
There is an effective procedure that, given an automaton $\bbA$ in 
$\AutW(\llang)$, returns an equivalent formula $\xi_{\bbA} \in \mu\llang$. 
Moreover, 

(1) $\xi_{\bbA} \in \mu_{D}\llang$ if $\bbA \in \AutW(\llang)$;

(2) $\xi_{\bbA} \in \mu_{C}\llang$ if $\bbA \in \AutWC(\llang)$.
\end{theorem}

\btbs
\item
THIS THEOREM NEEDS TO BE PROVED BUT PROBABLY IN THE FINAL VERSION WE 
WILL BE VERY BRIEF ABOUT IT TO SAVE SPACE.
\item
BELOW IS AN EARLIER PROOF OF A SPECIAL CASE.
\etbs

\begin{proof}
The argument  is a refinement of the standard proof showing that any automaton 
$\aut$ from $\Aut(\ofo)$ can be translated into an equivalent $\mu$-formula 
$\xi_\aut$ (cf. e.g. \cite[Section 6]{Ven08}), and it is essentially a special case of the argument proving Theorem \ref{thm:wmso_autofor}.


From now on, we always assume that a formula $\tmap(a,c)$ is in normal form. 
Following~\cite{Ven08}, we introduce another type of automata, called $(\prop,X)$-automata, which operate on $\p{(\prop \cup X)}$-trees.
They differ from automata whose one-step language is defined over predicates in $(A \cup X)$ in that\footnote{Parity automata based on $\ofo$ are thus simply $(\prop,\emptyset)$-automata.}
\begin{itemize}
\item Monadic predicate letters from $X$ can occur in the scope of a %existential
quantifier and only there, meaning that $(\prop,X)$-automata have transition 
$\tmap(a,c) \in \ofo^+(A\cup X)$
%
\item 
The transition function is uniquely determined by the restriction of the 
colouring to $\prop$, that is, for every $a \in A$, and $c_1, c_2 \in C$, if $c_1 \cap \prop = c_2 \cap \prop$ then $\tmap(a, c_1)= \tmap(a, c_2)$.
\end{itemize}
We also assume that
for every $x \in X$ there is a unique $a \in A$ and an unique $c \in C$ such that $x$ occurs in $\tmap(a,c)$.
The notion of acceptance is defined as expected, the only difference with being that during the acceptance game \'Eloise has to provide a valuation only for predicates in $A$ making formula given by the transition function true. It is then enough to prove the following claim.
\begin{claimfirst}\label{c:1}
Let $\aut$ be a $(\prop,X)$-automaton. Then, there is an effective procedure that associates to $\aut$ a formula $\xi_\aut \in \MC$ such that:
\begin{equation}\label{eq:c1}
\xi_\aut \in 
\begin{cases}\AFMC &\text{ if }\aut \in \AutW(\ofo) \\
\contAFMC &\text{ if }\aut \in \AutWC(\ofo) 
.
\end{cases}\end{equation}
Moreover all occurrences in $\xi_\aut$ of variables in $X$ are positive.
\end{claimfirst}
\begin{pfclaim} %\ref{c:1}


Without loss of generality, we can assume that:
\begin{itemize}
\itemsep 0 pt
\item Every (maximal) strongly connected component (SCC) in the graph of $\ord$ has an unique entrance point,
\item The directed acyclic graph (DAG) of the SCCs of $\ord$ is a tree, and more specifically,
\item 
$\{c \in A \mid a \leadsto c, c \prec a\}  \cap \{c \in A \mid b \leadsto c, c \prec b\}  = \emptyset$ whenever $a,b$ are in the same SCC, with $a\neq b$.
\end{itemize}

Given a $(\prop,X)$-automaton $\aut$, we are now going to define a function $\delta_\aut: A \to \ML (A \cup X \cup \prop)$
%\fcwarning{one-step ML undefined} 
that assigns to each state $a$ of $\aut$ a modal formula $\delta_\aut(a)$ over  $A \cup X \cup \prop$ representing all possible transitions from $a$ in the modal language.  

Let $c \in C$, and assume $\Delta(a,c)$ is in positive basic form $\bigvee \posdbnfofo{\Sigma}$. We define a first translation $TR_1$ taking as argument $\Delta(a,c)$ and giving as result a formula from the (guarded fragment of) first-order logic over $A \cup X \cup \prop$ as follows. %Assume $c \cap P= \{q_{c_1}, \dots, q_{c_\ell}\}$.
With every disjunct
$$
\posdbnfofo{\Sigma} = \bigwedge_{S\in\Sigma} \exists x. \tau^+_{S}(x) \land \forall z.( \bigvee_{S\in \Sigma} \tau^+_S(z)),
$$
we associate the formula

$$
TR_1(\posdbnfofo{\Sigma}) := \bigwedge_{S\in\Sigma} \exists y. (R(x,y) \land \tau^+_{S}(y)) \land \forall z.( R(x,z) \to \bigvee_{S\in \Sigma} \tau^+_S(z)).
$$
\fcwarning{Why do we need to go through this?}The formula $TR_1(\posdbnfofo{\Sigma})$ is bisimulation invariant, and it is equivalent to the modal formula

$$
TR_2(\posdbnfofo{\Sigma}) := \bigwedge_{S\in\Sigma}  \Diamond(\bigwedge S) \land \Box \bigvee_{S\in \Sigma} (\bigwedge S).
$$
\fcwarning{Maybe better to define this directly}
Let $TR_3(\Delta(a,c))= \bigwedge (c \cap \prop) \land \bigwedge_{p \in \prop \setminus c} \lnot p \land \bigvee TR_2(\posdbnfofo{\Sigma})$.
 The modal formula $\delta_\aut(a)$ is then defined as

 \[
 \bigvee_{c \in C} TR_3(\Delta(a,c)).
 \]
By construction we have, for every $\model$,
    \begin{eqnarray*}
    \model[x\mapsto s_I] \models \bigvee_{c \in C} \big (\tau_{(c \cap \prop)}(y) \land \bigvee TR_1(\posdbnfofo{\Sigma})\big) & \text{iff} &\model \mmodels \delta_\aut(a).
    \end{eqnarray*}
Moreover, if $\aut$ satisfies continuity, it holds that $\delta_\aut(a)$ is continuous in $b$ whenever $b \in A$ is in the same $\ord$-cycle of $a$. Dually for $\pmap(a)=0$.


A modal automaton over $\prop$ is an automaton $ \tup{A, \delta, \pmap, a_I}$ such that $\delta : A \to \ML^+ (A)$, where $\ML^+ (A)$ is the set of all modal formulas over propositions $A \cup \prop$ such that elements from $A$ appear only positively.
The acceptance game associated with such an automaton and a tree $\model$ is determined by the (symmetric) acceptance game defined according to the rules of Table~\ref{symmetric_modal_game}.
This means that we can equivalently see the automaton $\aut$ as a modal automaton $\tup{A, \delta_\aut, \pmap, a_I}$ whose transition function satisfies the weakness condition, and also continuity when $\aut$ is weak-continuous. Thus, from now on we see $\aut$ as the equivalent modal automaton we have just described.%\fcwarning{Define $n_A$}

\begin{table}[h]
  \centering
\begin{tabular}{|l|c|l|c|}
 \hline
  % after \\: \hline or \cline{col1-col2} \cline{col3-col4} ...
  Position & Player & Admissible moves & Parity\\
   \hline
  $(a,s) \in A \times S$ & $\exists$ & $\{(\delta_\aut(a),s)\}$ & $\pmap(a)$\\
  $(\psi_1 \vee \psi_2,s)$ & $\exists$ & $\{(\psi_1,s),(\psi_2,s) \}$ & $-$ \\
  $(\psi_1 \wedge \psi_2,s)$ & $\forall$ & $\{(\psi_1,s),(\psi_2,s) \}$ & $-$ \\
  $(\Diamond\varphi,s)$ & $\exists$ & $\{(\varphi,t)\ |\ t \in R[s] \}$ & $-$ \\
  $(\Box\varphi,s)$ & $\forall$ & $\{(\varphi,t)\ |\ t \in R[s] \}$ & $-$ \\
  % $(\bot,s)$ & $\exists$ & $\emptyset$ & $n_A$ \\
  % $(\top,s)$ & $\forall$ & $\emptyset$ & $n_A$ \\
  $(\lnot p,s) \in \prop \times S$ and $p \notin \tscolors(s)$ & $\forall$ & $\emptyset$ & $-$\\
  $(\lnot p,s) \in \prop \times S$ and $p \in \tscolors(s)$ & $\exists$ & $\emptyset$ & $-$\\
  $(p,s) \in \prop \times S$ and $p \in \tscolors(s)$ & $\forall$ & $\emptyset$ & $-$\\
  $(p,s) \in \prop \times S$ and $p \notin \tscolors(s)$ & $\exists$ & $\emptyset$ & $-$\\

  \hline
\end{tabular}
 \caption{(Symmetric) acceptance game for modal automata}
 \label{symmetric_modal_game}
\end{table}





For the construction of $\xi_\aut$, we proceed by induction on the tree height of the DAG $t$ of SCC. If the height is 1, that is the DAG is a single point graph, we reason as follows.
 We have two cases to consider: either the SCC is trivial (i.e. it consists of a single non looping node), or not.
In the first case, $A=\{a_I\}$ and $\aut$ is equivalent to $\xi_\aut:=\delta_\aut(a_I)$.

For the second case, let us assume that $\pmap(a_I)=1$, the case when it is $0$ being, mutatis mutandis, the same.
Let $A=\{a_0, \dots, a_\ell\}$, and $a_I=a_\ell$.
Notice that when $\aut$ is a weak modal automaton satisfying the continuity condition, given $a,b \in A$, if $b$ occurs in $\delta_\aut(a)$, then $b$ is only in the scope of $\Diamond$ operator. 
We can now see the automaton $\bbA$
as a system of modal equations, and by applying the standard inductive procedure \emph{solves} this system of equations and
construct the least fixpoint formula $\xi_\aut$ equivalent to $\aut$, 

Here the key observation is that the starting conditions on
strongly connected components of the automaton ensure that when we execute
a single step in solving the system of equations, we 
may work within either the alternation-free fragment or the
(syntactically) continuous fragment of the modal $\mu$-calculus.
From this, we can deduce that $\xi_\aut$ satisfies Equation \ref{eq:c1}
 Clearly the procedure preserves the polarity of each $x \in X$, meaning that all variables in $X$ are positive in $\xi_\aut$.


For the induction step, assume the successors of the root of $t$ are $(n_1, \dots, n_\ell)$. For each $i \in \{1,\dots,\ell\}$, let $a_i$ be the entrance point of the SCC of $n_i$, and let $\aut_{i}$ be the automaton $\aut$ but having as an initial state $a_i$. If we do not consider the states that are not reachable by $a_i$, the DAG of the SCC of $\aut_{i}$ is $t.{n_i}$ (the subtree of $t$ starting at $n_i$).
Let $Y=\{a_1, \dots, a_\ell\}$, and $M$ be the set of states of $\aut$ that belong to the root of $t$. We assume $X \cap Y = \emptyset$. The structure
\[
\aut_M := \tup{M, \delta_\aut|_{M}, \pmap|_{M}, a_I}
\] is a $(\prop, X \cup Y)$-automaton.

The inductive hypothesis applies to automata $\aut_M, \aut_{1}, \dots, \aut_{\ell}$. Thus we obtain fixpoint formulas $\xi_M, \xi_1, \dots, \xi_\ell$, the former taking free variables in $\prop \cup X \cup Y$, all the remaining in $\prop \cup X$, equivalent to $\aut_M, \aut_1, \dots, \aut_\ell$ respectively.
Notice that:
\begin{itemize}
\item by induction hypothesis, $\xi_M, \xi_1, \dots, \xi_\ell$ all satisfy Equation \ref{eq:c1}, every variable $x \in X \cup Y$ is positive in each of those formulas (if $x$ occurs in it),
\item by construction, if $x$ is free in $\xi_i$, then $x$ is not bounded in $\xi_{M}$.
\end{itemize}
 We can therefore deduce that
 $\xi_\aut= \xi_{M}[a_1\mapsto\xi_{1}, \dots, a_\ell\mapsto\xi_{\ell}]$
  %\in \contAFMC$
also satisfies Equation \ref{eq:c1}, and that each variable from $X$ occurs positively in $\xi_\aut$.

 We verify that $\model \mmodels \xi_{M}[a_1\mapsto\xi_{1}, \dots, a_\ell\mapsto\xi_{\ell}]$ iff $\model \in \trees(\aut)$, for every model $\model$.
 %\fcwarning{I think the $(\model,s)$ thould be $\model$ or rather a variant of $\model$ with a changed point}
But this follows by the following two facts:
\begin{enumerate}
\item $\model\mmodels \xi_{M}[a_1\mapsto\xi_{1}, \dots, a_\ell\mapsto\xi_{\ell}]$ iff $\model[a_1\mapsto \ext{\xi_1}^{\model}, \dots, a_\ell\mapsto \ext{\xi_\ell}^{\model}  ] \mmodels \xi_M$,
\item $\model \in \trees(\aut)$  iff $\model[a_1\mapsto \ext{\aut_1}^{\model}, \dots, a_\ell\mapsto \ext{\aut_\ell}^{\model}  ] \in \trees(\aut_M)$
\end{enumerate}
where %$\ext{\xi_i\ext{_{\model}=\{ s \in \model \mid s \in \ext{\xi_i\ext{^\model \}$, and 
$\ext{\aut_i}^{\model} := \{ s \in \model \mid \model.s \in \trees(\aut_i) \}$. 
\end{pfclaim}
This finishes the proof of Theorem~\ref{t:autofor}. 
\end{proof}
