%!TEX root = ../00CFVZ_TOCL.tex

In this section we show that any $\wmso$-automaton $\aut$ can be simulated by a ``two-sorted'' $\wmso$-automaton $\mb{A}^{\f}$. The leading intuition is that $\mb{A}^{\f}$ will consist of one copy of $\aut$ (based on a set of states $A$) and a variant of its powerset construction, which will be based both on states from $A$ and ``macro-states'' from $\pw (A \times A)$.\footnote{It is customary for powerset constructions on parity automata to encode macro-states as binary relations between states (from $\pw (A \times A)$) instead of plain sets (from $\pw A$). Such additional structure is needed to correctly associate with a run on macro-states the corresponding bundle of runs of the original automaton $\aut$. We refer to the standard literature on parity automata (e.g. \cite{Walukiewicz96,ALG02}) for further details.} Successful runs of $\mb{A}^{\f}$ will have the property of processing only a \emph{finite} amount of the input with $\mb{A}^{\f}$ being in a macro-state and all the rest with $\mb{A}^{\f}$ behaving exactly as $\aut$.
%\yvwarning{some more intuitions are required, eg on macro-states FZ: I put some more intuition on the finitary construction. I emphasized the novelties, while in my opinion the observations on macro-states being relations is standard for tree automata and should not be recalled in details (I recalled in a footnote).}

\fcwarning{consider figure, see ``soaut-'' files from PDL paper}
\input{fig-twopart.tex}

\begin{comment} %Extended alternative version...
For the purpose of defining $\mb{A}^{\f}$, we first need some preliminaries to shape our variant of the powerset construction. As standard in automata theory, the idea is that the powerset construct $\mb{A}^{\sharp}$ on $\mb{A}$ mimics multiple runs of $\mb{A}$ acting in parallel on the same input. Thus states of $\mb{A}^{\sharp}$ will be in fact ``macro-states'', each representing a set of states of $\mb{A}$. However, in order to define a correct notion of acceptance for $\mb{A}^{\sharp}$, one needs to keep track of the structure of each run of $\mb{A}$ that is simulated in parallel. For this reason, the macro-states of $\mb{A}^{\sharp}$ are not given as plain sets of states from $\aut$ but instead as \emph{binary relations}: the idea is that a pair $(a,b)$ in a macro state encodes the information that one of the simulated runs of $\aut$ is in state $b$ at the current stage and was at state $a$ at the previous stage. We refer to the standard literature on tree automata (e.g. \cite{Walukiewicz96,ALG02}) for further details.

Next we introduce the ingredients to define our variant of the powerset construction. The following is a notion of lifting for types on states that is instrumental in defining a translation to types on macro-states.
\end{comment}


To achieve this result, we first need some preliminary definitions. The following is a notion of lifting for types on states that is instrumental in defining a translation to types on macro-states. The distinction between empty and non-empty subsets of $A$ is to make sure that empty types on $A$ are lifted to empty types on $\pw A$.

\begin{definition}\label{def:typelifting}
Given a set $A$ of unary predicates and $\Sigma \subseteq \wp A$, we define the \emph{lifting} $\lift{\Sigma} \subseteq \wp \wp A$ as $\{\{S\} \mid S \in \Sigma \wedge S \neq \emptyset\} \cup
    \{\emptyset \mid \emptyset \in \Sigma \}$.
\end{definition}

The next step is to define a translation on the sentences associated with the
transition function of the original $\wmso$-automaton, say with set of states $A$. Following the intuition given above, the idea is that we want to work with sentences that can be made true by assigning macro-states (from $\wp(A \times A)$) to finitely many nodes in the model, and ordinary states (from $A$) to all the other nodes. Henceforth, we use the notation $\shA$ for the set $\wp(A \times A)$.

\begin{definition}\label{DEF_finitary_lifting}
Let $\varphi \in {\olque}^+(A \times A)$ be a formula of shape $\posdbnfofoei{\vlist{T}}{\Pi}{\Sigma}$ for some $\Pi,\Sigma \subseteq \shA$ and $\vlist{T} = \{T_1,\dots,T_k\} \subseteq \shA$. Let $\widetilde{\Sigma}\subseteq \wp A$ be $\widetilde{\Sigma} := \{\Ran(S) \mid S \in \Sigma\}$. We define $\varphi^{\f} \in {\olque}^+(A \cup \shA )$ as follows:
$$(\posdbnfofoei{\vlist{T}}{\Pi}{\Sigma})^{\f} := \posdbnfofoei{\lift{\vlist{T}}}{\lift{\Pi} \cup \lift{\Sigma}}{\widetilde{\Sigma}}. $$
Observe that each ${\tau}^{+}_{P}$ with $P \in \widetilde{\Sigma}$ appearing in $\varphi^{\f}$ is a (positive) $A$-type, as $P = \Ran(S) \subseteq A$ for some $S \in \Sigma$.
%Following the notation of Definition \ref{def:basicform_folque}, $\varphi$ and $\varphi^{\f}$ can be represented respectively as $\dbnfolque{\vlist{T}}{\Pi}{\Sigma}$ and $\dbnfolque{\lift{\vlist{T}}}{\lift{\Pi} \cup \lift{\Sigma}}{\Sigma}$.
\end{definition}

\noindent Our desiderata on the translation $(-)^{\f}$ concern the notions of \emph{continuity} and \emph{functionality}.

\begin{definition} Given a set $A$ of unary predicates and $B \subseteq A$, we say that a sentence $\varphi \in {\olque}^+(A)$ is \emph{functionally continuous in $B$} if, for every model $(D,\val \: A \to \wp(D))$,
\begin{align*}
\text{if } (D,\val),\ass \models \varphi \text{ then } & \exists\ \val' \: A \to \wp(D) \text{ such that } (D, \val'),\ass \models \varphi, \\
& \val'(a)\subseteq \val(a) \text{ for all } a \in A, \tag{$\val'$ is a restriction of $\val$}\\
 & \val'(b) \text{ is finite for all }b \in B \text{ and } \tag{continuity in $B$}\\
 & \val'(b)\cap \val'(a) = \emptyset \text{ for all } a \in A\setminus\{b\} \text{ and }b \in B\tag{functionality in $B$}.
\end{align*}
%Moreover, $\varphi$ is \emph{functionally continuous in $B \subseteq A$} if it is so for each $b \in B$.
\end{definition}
In words, $\varphi$ is functionally continuous in $B$ if it is continuous in each $b \in B$ and, for each model $(D,\val)$ where $\varphi$ is true, there is a restriction $\val'$ of $\val$ which both witnesses continuity and does not assign any other $a \in A$ to the elements marked with some $b \in B$.

\begin{lemma}\label{LEM_cont}
Let $\varphi \in {\olque}^+(A \times A)$ and $\varphi^{\f}\in {\olque}^+(A\cup \shA )$ be given as in Definition~\ref{DEF_finitary_lifting}. Then $\varphi^{\f}$ is functionally continuous in $\shA$.
 \end{lemma}

\begin{proof}
%\yvwarning{this proof could use some more detail FZ: I expanded the proof and tried to make it clearer}
We first unfold the definition of $\varphi^{\f}$ as follows:
\begin{align*}
\varphi^{\f} =\ &
\underbrace{
    \exists \vlist{x}.\big(\arediff{\vlist{x}} \land \bigwedge_{0 \leq i \leq n} \tau^+_{\lift{T}_i}(x_i)
}_{\psi_1}
\land \underbrace{
    \forall z.(\arediff{\vlist{x},z} \lthen \bigvee_{S\in \lift{\Pi} \cup \lift{\Sigma} \cup \widetilde{\Sigma}} \tau^+_S(z))\big)
}_{\psi_2}
\land
\\ & \underbrace{
    \bigwedge_{P\in\widetilde{\Sigma}} \qu y.{\tau}^{+}_P(y)
}_{\psi_3} \land
 \underbrace{
    \dqu y.\bigvee_{P\in\widetilde{\Sigma}} {\tau}^{+}_P(y)
}_{\psi_4} .
\end{align*}
Observe that $\psi_1 \land \psi_2$ is just $\mondbnfofoe{\lift{\vlist{T}}}{\lift{\Pi} \cup \lift{\Sigma} \cup \widetilde{\Sigma}}{+}$. Now suppose that $(D,\val \: (A \cup \shA ) \to \wp(D))$ is a model where $\varphi^{\f}$ is true. This amounts to the truth of subformulas $\psi_1$, $\psi_2$, $\psi_3$ and $\psi_4$ whose syntactic shape yields information on the types of elements of $D$. In particular, we can define a partition of $D$ into subsets $D_1$, $D_2$, $D'_2$ as follows:
\begin{itemize}
  \item As $\psi_1$ is true, we can pick $n$ distinct elements $s_1,\dots,s_n$ of $D$ such that $s_i$ witnesses the positive type $\lift{T}_i$, %\tau^+_{\lift{T}_i}(x_i)$,
   that is, $s_i \in \val(S)$ for each $S \in \lift{T}_i$. We define $D_1 := \{s_1,\dots,s_n\}$.
  %
  \item  As $\psi_2$ is true, we can cover all the elements not in $D_1$ with two disjoint sets $D_2$ and $D'_2$ given as follows. The set $D_2$ is defined to contain all the elements not in $D_1$ witnessing a type ${\tau}^{+}_P(z)$ with $P \in \widetilde{\Sigma}$. The set $D'_2$ is just the complement of $D_1 \cup D_2$: by syntactic shape of $\psi_2$, all elements of $D'_2$ witness a positive type ${\tau}^{+}_S$ with
  $S \in \lift{\Pi} \cup \lift{\Sigma}$.
  %
  \item The truth of the subformula $\psi_4$ yields the information that the set $D_1 \cup D'_2$ is finite. If $\widetilde{\Sigma}$ is non-empty, the truth of $\psi_3$ implies that the set $D_2$ is infinite.
 \end{itemize}
This partition uniquely associates with each $s \in D$ a type ${\tau}^{+}_S$ witnessed by $s$ and thus a set of unary predicates $S_s := S \subseteq A \cup \shA$. We can then define a valuation $\val'$ assigning to each element $s$ of $D$ exactly the set $S_s$.

We now check the properties of $\val'$. As the partition inducing $\val'$ follows the syntactic shape of $\varphi^{\f}$, one can observe that $\val'$ is a restriction of $\val$ and $(D,\val')$ makes $\varphi^{\f}$ true. By definition of the partition, $\val'$ assigns unary predicates from $\shA$ only to elements in the finite set $D_1 \cup D'_2$, meaning that $\varphi^{\f}$ is continuous in $\shA$. Furthermore, $\val'$ assigns at most one unary predicate from $\shA$ to each element of $D_1 \cup D'_2$, because $\lift{\vlist{T}} \cup \lift{\Pi} \cup \lift{\Sigma}$ is defined as the lifting of $\vlist{T} \cup \Pi \cup \Sigma$. It follows that $\varphi^{\f}$ is also functional in $\shA$. Since the same restriction $\val'$ yields both properties, $\varphi^{\f}$ is functionally continuous in $\shA$.
\end{proof}

\begin{remark} As $\varphi^{\f}$ is of shape $\posdbnfofoei{\lift{\vlist{T}}}{\lift{\Pi} \cup \lift{\Sigma}}{\widetilde{\Sigma}}$ with $R \not\in \bigcup\widetilde{\Sigma}$ for each $R \in \shA$, by application of Corollary \ref{cor:olquecontinuousnf} we would immediately get that $\varphi^{\f}$ is continuous in each $R \in \shA$. However, we do not use this observation in proving Lemma \ref{LEM_cont} and propose instead a more direct argument, allowing to show both continuity and functionality at once.
\end{remark}

The next definition is standard (see e.g.  \cite{Walukiewicz96,Ven08}) as an intermediate step to define the transition function of the powerset construct for parity automata.

\begin{definition}\label{DEF_delta star} Let $\mb{A} = \tup{A,\Delta,\Omega,a_I}$ be a $\wmso$-automaton. Fix $a \in A$ and $c \in C$. The sentence $\Delta^{\star}(a,c)$ is defined as
\begin{eqnarray*}
      % \nonumber to remove numbering (before each equation)
        \Delta^{\star}(a,c) &:=& \Delta(a,c)[b \mapsto (a,b) \mid b \in A].
      \end{eqnarray*}
%where $\Delta(a,c)[(a,b)\setminus b\mid b \in A]$ denotes the sentence in ${\olque}^+(A\times A)$ obtained by replacing each occurrence of an unary predicate $b \in A$ in $\Delta(a,c)$ with the unary predicate $(a,b) \in A \times A$.
\end{definition}

 Next we combine the previous definitions to characterize the transition function associated with the macro-states.

\begin{definition}\label{PROP_DeltaPowerset}
Let $\aut = \tup{A,\Delta,\Omega,a_I}$ be a $\wmso$-automaton. Let $c \in C$ be a label and $Q \in \shA$ a binary relation on $A$. By Corollary \ref{cor:olquepositivenf}, for some $\Pi,\Sigma \subseteq \shA$ and $T_i \subseteq A \times A$, there is a sentence $\Psi_{Q,c} \in {\olque}^+(A\times A)$ in the basic form $\bigvee \posdbnfofoei{\vlist{T}}{\Pi}{\Sigma}$ such that
\begin{eqnarray*}
% \nonumber to remove numbering (before each equation)
  \bigwedge_{a \in \Ran(Q)} \Delta^{\star}(a,c) &\equiv& \Psi_{Q,c}.
\end{eqnarray*}
By definition $\Psi_{Q,c}$ is of the form $\bigvee_{i}\varphi_i$, with each $\phi_{i}$ of shape $\posdbnfofoei{\vlist{T}}{\Pi}{\Sigma}$. We put $\shDe(Q,c) := \bigvee_{i}\varphi_i^{\f}$, where the translation $(-)^{\f}$ is given as in Definition~\ref{DEF_finitary_lifting}. Observe that $\shDe(Q,c)$ is of type ${\olque}^+(A \cup \shA)$.
\end{definition}

We have now all the ingredients to define our two-sorted automaton.

\begin{definition}\label{def:finitaryconstruct}
Let $\aut = \tup{A,\Delta,\Omega,a_I}$ be a {\wmso-automaton}. We define the \emph{finitary construct over $\mb{A}$} as the automaton $\aut^{\f} = \tup{A^{\f},\Delta^{\f},\Omega^{\f},a_I^{\f}}$ given by
\begin{eqnarray*}
      % \nonumber to remove numbering (before each equation)
        A^{\f} &:=& A \cup \shA \\
        %\leq^{2S} &:=& \leq\ \cup\ (\shA \times A)\ \cup\ (\shA \times \shA)\\
        a_I^{\f} &:=& \{(a_I,a_I)\}\\
        \Delta^{\f}(a,c) &:=& \Delta(a,c)\\
        \Delta^{\f}(R,c) &:=& \shDe(R,c) \vee \bigwedge_{a \in \Ran(R)} \Delta(a,c)\\
        \Omega^{\f}(a) &:=& \Omega(a)\\
        \Omega^{\f}(R) &:=& 1.
      \end{eqnarray*}
\end{definition}

The underlying idea of Definition \ref{def:finitaryconstruct} is the same of the \emph{two-sorted construction} (\emph{cf.} \cite[Def.~3.7]{Zanasi:Thesis:2012}, \cite{DBLP:conf/lics/FacchiniVZ13}) for weak $\mso$-automata. In both cases we want that macro-states process just a \emph{well-founded} portion of any accepted tree: this is guaranteed by associating all macro-states with the odd parity value $1$. However, for the finitary construction we aim at the stronger condition that such a portion is \emph{finite}. To achieve this, the key difference with the two-sorted construction is in the use of the translation $(-)^{\f}$ to define $\shDe$: as $\Delta$ may be specified using quantifiers $\qu$ and $\dqu$, it serves the purpose of tracking the cardinality constraints of the original $\wmso$-automaton and ensure that they are not lifted to constraints on macro-states.

\begin{comment} Remark on minimality
\begin{remark} Let $\mb{A}^{\f}$ be the finitary construct of some $\wmso$-automaton $\mb{A}$ and $\model$ an input model. While playing the acceptance game $\mathcal{A}(\mb{A}^{\f},\model)$, it is in $\exists$'s interest to make the fewest number of moves available for $\forall$. Thus at any position $(q,s) \in A^{\f} \times T$, a rational choice for her would be to assign to each node in $\sigma_R(s)$ only the ``strictly necessary'' amount of states that makes $\Delta^{\f}(q,\V(s))$ true. Following this intuition, we can always assume the following on $\exists$'s strategy $f$ in $\mathcal{A}(\mb{A}^{\f},\model)$:
\begin{itemize}
  \item from any position of the form $(a,s) \in A \times T$, the valuation suggested by $f$ only assigns predicates from $A$ to nodes in $\R{s}$;
  \item from any position of the form $(R,s) \in \shA \times T$, the valuation suggested by $f$ assigns either only predicates from $A$ or only predicates from $\shA$ to nodes in $\R{s}$.
\end{itemize}
The first assumption can be made as only predicates from $A$ appear in $\Delta^{\f}(a,\V(s)) = \Delta(a,\V(s)$, whereas the second depends upon the fact that $\Delta^{\f}(R,\V(s))$ consists of two disjuncts
By assuming that $\exists$ plays according to this idea of rationality, we can rule out redundant valuations such as $\val^{\prime}$. Following these intuitions, we introduce the notion of \emph{minimal strategy}.
\end{remark}
\end{comment}

The next proposition establishes the desired properties of the finitary
construct. To this aim, we first introduce the notions of functional and finitary strategy.

\begin{definition}\label{def:StratfunctionalFinitary}
Given a $\wmso$-automaton $\bbA = \tup{A,\tmap,\pmap,a_I}$ and transition system $\bbT$, a strategy $f$ for \eloise in $\mathcal{A}(\bbA,\model)$ is \emph{functional in $B \subseteq A$} (or simply functional, if $B=A$) if for each node $s$ in $\bbT$ there is at most one $b \in B$ such that $(b,s)$ is a reachable position in an $f$-guided match. Also $f$ is \emph{finitary} in $B$ if there are only finitely many nodes $s$ in $\bbT$ for which a position $(b,s)$ with $b \in B$ is reachable in an $f$-guided match.
\end{definition}

% we say that a strategy for $\exists$ in an acceptance game $\mathcal{A}(\aut,\model)$
% is \emph{functional in a set $B$} of states if it assigns at most one state
% from $B$ to each node in $\mb{T}$, and it is \emph{finitary in $B$} if it
% assigns states from $B$ only to finitely many nodes of $\mb{T}$.

\begin{lemma}\label{PROP_facts_finConstr} Let $\mb{A}$ be a $\wmso$-automaton and $\mb{A}^{\f}$ its finitary construct over $\mb{A}$. The following holds:
\begin{enumerate}
  \itemsep 0 pt
  \item $\mb{A}^{\f}$ is a $\wmso$-automaton. \label{point:finConstrAut}
  \item For any $\mb{T}$, if $\exists$ has a winning strategy in
  the game $\mathcal{A}(\aut^{\f},\model)@(a_I^{\f},s_I)$, then she has a winning strategy in the same game which is both functional and finitary in $\shA$. \label{point:finConstrStrategy}
  \item $\mb{A} \equiv \mb{A}^{\f}$. \label{point:finConstrEquiv}
  \end{enumerate}
\end{lemma}
\begin{proof} %As observed above, the finitary construction resembles the two-sorted construction.
We address each point separately.
\begin{enumerate}
  \item We need to show that $\mb{A}^{\f}$ is weak and respects the continuity condition. For this purpose, we fix the following observation:
      \begin{itemize}
      \item[($\star$)] by definition of $\Delta^{\f}$, for any macro-state $R \in \shA$ and state $a \in A$, it is never the case that $a \preceq R$.
      \end{itemize}
      This means that, when considering a strongly connected component of $\mb{A}^{\f}$, we may assume that all states involved are either from $A$ or from $\shA$.

      In order to prove our claim, let $q_1,q_2 \in A^{\f}$ be two states of $\mb{A}^{\f}$ such that $q_1 \preceq q_2$ and $q_2 \preceq q_1$. By observation ($\star$), we can distinguish the following two cases:
      \begin{enumerate}[(\roman*)]
        \item if $q_1$ and $q_2$ are states from $A$, then for $i \in \{1,2\}$ the value of $\Omega^{\f}(q_i)$ and $\Delta^{\f}(q_i,c)$ is defined respectively as $\Omega(q_i)$ and $\Delta(q_i,c)$ like in the $\wmso$-automaton $\mb{A}$. It follows that they satisfy both the continuity and weakness condition.
        \item Otherwise, $q_1$ and $q_2$ are macro-states in $\shA$. For the weakness condition, observe that all macro-states in $\aut^{\f}$ have the same parity value. For the continuity condition, suppose that $q_1$ occurs in $\Delta^{\f}(q_2,c)$ for some $c \in C$. By definition $q_1$ can only appear in the disjunct $\shDe(q_2,c) = \bigvee_{i}\varphi_i^{\f}$ of $\Delta^{\f}(q_2,c)$. By Lemma \ref{LEM_cont}, we know that each $\varphi_i^{\f}$ is continuous in $\shA$. Then in particular $\Delta^{\f}(q_2,c)$ is continuous in $q_1$. By definition $\Omega^{\f}(q_1) =1$ is odd, meaning that the continuity condition holds. The case in which $q_2$ appears in $\Delta^{\f}(q_1,c)$ is just symmetric.
      \end{enumerate}
  \item  Let $f$ be a winning strategy for $\exists$ in $\mathcal{A}(\mb{A}^{\f},\model)@(a_I^{\f},s_I)$. We define a strategy $f'$ for $\exists$ in the same game as follows:
      \begin{enumerate}[label=(\alph*),ref=\alph*]
        \item on basic positions of the form $(a,s) \in A\times T$, let $\val$ be the valuation suggested by $f$. We let the valuation suggested by $f'$ be the restriction $\val'$ of $\val$ to $A$. Observe that, as no predicate from $A^{\f}\setminus A =\shA$ occurs in $\Delta^{\f}(a,\V(s)) = \Delta(a,\V(s))$, then $\val'$ also makes that sentence true in $\R{s}$.
        \begin{comment} With minimality
        on basic positions of the form $(a,s) \in A\times T$, $f'$ is defined as $f$. Indeed, as no predicate from $\shA$ occurs in $\Delta^{\f}(a,\V(s))$, we can assume that the valuation suggested by $f$ does not assign any of them to nodes in $\R{s}$.
        \end{comment}
        \label{point:stat2point1}
        \item for basic positions of the form $(R,s) \in \shA \times T$, let $\val_{R,s}$ be the valuation suggested by $f$. As $f$ is winning, $\Delta^{\f}(R,\V(s))$ is true in the model $\val_{R,s}$. If this is because the disjunct $\bigwedge_{a \in \Ran(R)} \Delta(a,\V(s))$ is made true, then we can let $f'$ suggest the restriction to $A$ of $\val_{R,s}$, for the same reason as in \eqref{point:stat2point1}. Otherwise, the disjunct $\shDe(R,\V(s)) = \bigvee_{i}\varphi_i^{\f}$ is made true. This means that, for some $i$,
             $$(R[s], \val_{R,s}) \models \varphi_i^{\f}.$$
             By Lemma \ref{LEM_cont} $\varphi_i^{\f}$ is functionally continuous in $\shA$, meaning that we have a restriction $\val_{R,s}'$ of $\val_{R,s}$ that verifies $\varphi_i^{\f}$, assigns finitely many nodes to predicates from $\shA$ and associates with each node at most one predicate from $\shA$. We let $\val_{R,s}'$ be the suggestion of $f'$ from position $(R,s)$.
      \end{enumerate}
      The strategy $f'$ defined as above is immediately seen to be
      surviving for $\exists$. It is also winning, because the set of
      basic positions on which $f'$ is defined is a subset of the one
      of the winning strategy $f$. By this observation it also follows that any $f'$-conform match visits basic positions of the form $(R,s) \in \shA \times C$ only finitely many times, as those have odd parity. By definition, the valuation suggested by $f'$ only assigns finitely many nodes to predicates in $\shA$ from positions of that shape, and no nodes from other positions. It follows that $f'$ is finitary in $\shA$. Functionality in $\shA$ also follows immediately by definition of $f'$.
  \item The proof is entirely analogous to the one presented in \cite[Prop. 3.9]{Zanasi:Thesis:2012} for the two-sorted construction. For the direction from left to right, it is immediate by definition of $\mb{A}^{\f}$ that a winning strategy for $\exists$ in $\mc{G} = \mathcal{A}(\aut,\model)@(a_I,s_I)$ is also winning for $\exists$ in $\mc{G}^{\f} = \mathcal{A}(\mb{A}^{\f},\model)@(a_I^{\f},s_I)$.

      For the direction from right to left, let $f$ be a winning strategy for $\exists$ in $\mc{G}^{\f}$. The idea is to define a strategy $f'$ for $\exists$ in stages, while playing a match $\pi'$ in $\mc{G}$. In parallel to $\pi'$, a shadow match $\pi$ in $\mc{G}^{\f}$ is maintained, where $\exists$ plays according to the strategy $f$. For each round $z_i$, we want to keep the following relation between the two matches:
\smallskip
\begin{center}
\fbox{\parbox{12cm}{
Either
\begin{enumerate}[label=(\arabic*),ref=\arabic*]
  \item basic positions of the form $(Q,s) \in \shA \times T$ and $(a,s) \in A \times T$ occur respectively in $\pi$ and $\pi'$, with $a \in \Ran(Q)$,
\end{enumerate}
or
\begin{enumerate}[label=(\arabic*),ref=\arabic*]
  \item[(2)] the same basic position of the form $(a,s) \in A \times T$ occurs in both matches.
\end{enumerate}
}}\hspace*{0.3cm}($\ddag$)
\end{center}
\smallskip
The key observation is that, because $f$ is winning, a basic position of the form $(Q,s) \in \shA \times T$ can occur only for finitely many initial rounds $z_0,\dots,z_n$ that are played in $\pi$, whereas for all successive rounds $z_n,z_{n+1},\dots$ only basic positions of the form $(a,s) \in A \times T$ are encountered. Indeed, if this was not the case then either $\exists$ would get stuck or the minimum parity occurring infinitely often would be odd, since states from $\shA$ have parity $1$.

It follows that enforcing a relation between the two matches as in ($\ddag$) suffices to prove that the defined strategy $f'$ is winning for $\exists$ in $\pi'$. For this purpose, first observe that $(\ddag).1$ holds at the initial round, where the positions visited in $\pi'$ and $\pi$ are respectively $(a_I,s_I) \in A \times T$ and $(\{(a_I,a_I)\},s_I) \in A^{\f} \times T$. Inductively, consider any round $z_i$ that is played in $\pi'$ and $\pi$, respectively with basic positions $(a,s) \in A \times T$ and $(q,s) \in A^{\f} \times T$. In order to define the suggestion of $f'$ in $\pi'$, we distinguish two cases.
\begin{itemize}
  \item First suppose that $(q,s)$ is of the form $(Q,s) \in
  \shA\times T$. By ($\ddag$) we can assume that $a$ is in $\Ran(Q)$. Let $\val_{Q,s} :A^{\f} \rightarrow \wp(\R{s})$ be the valuation suggested by $f$, verifying the sentence $\Delta^{\f}(Q,\V(s))$. We distinguish two further cases, depending on which disjunct of $\Delta^{\f}(Q,\V(s))$ is made true by $\val_{Q,s}$.
      \begin{enumerate}[label=(\roman*), ref=\roman*]
        \item If $(\R{s},\val_{Q,s})\models \bigwedge_{b \in \Ran(Q)} \Delta(b,\V(s))$, then we let $\exists$ pick the restriction to $A$ of the valuation $\val_{Q,s}$. \label{point:valuation1}
        \item If $(\R{s},\val_{Q,s})\models \shDe(Q,\V(s))$, we let $\exists$ pick a valuation $\val_{a,s}:A \rightarrow \p (\R{s})$ defined by putting, for each $b \in A$:
            \begin{align*}
            % \nonumber to remove numbering (before each equation)
               \val_{a,s}(b)\ :=\ \bigcup_{b \in \Ran(Q')} &\{t \in \R{s} \mid t \in \val_{Q,s}(Q')\} \\
               \cup\ \ \ \ \ & \{t \in \R{s} \mid t \in \val_{Q,s}(b)\} .
            \end{align*} \label{point:valuation2}
      \end{enumerate}
      It can be readily checked that the suggested move is admissible for $\exists$ in $\pi$, i.e. it makes $\Delta(a,\V(s))$ true in $\R{s}$. For case \eqref{point:valuation2}, one has to observe how $\shDe$ is defined in terms of $\Delta$. In particular, the nodes assigned to $b$ by $\val_{Q,s}$ have to be assigned to $b$ also by $\val_{a,s}$, as they may be necessary to fulfill the condition, expressed with $\qu$ and $\dqu$, that infinitely many nodes witness (or that finitely many nodes do not witness) some type.

      We now show that $(\ddag)$ holds at round $z_{i+1}$. If \eqref{point:valuation1} is the case, any next position $(b,t)\in A \times T$ picked by player $\forall$ in $\pi'$ is also available for $\forall$ in $\pi$, and we end up in case $(\ddag .2)$. Suppose instead that \eqref{point:valuation2} is the case. Given the choice $(b,t) \in A \times T$ of $\forall$, by definition of $\val_{a,s}$ there are two possibilities. First, $(b,t)$ is also an available choice for $\forall$ in $\pi$, and we end up in case $(\ddag .2)$ as before. Otherwise, there is some $Q' \in \shA$ such that $b$ is in $\Ran(Q')$ and $\forall$ can choose $(Q',t)$ in the shadow match $\pi$. By letting $\pi$ advance at round $z_{i+1}$ with such a move, we are able to maintain $(\ddag .1)$ also in $z_{i+1}$.
  \item In the remaining case, inductively we are given the same basic position $(a,s) \in A\times T$ both in $\pi$ and in $\pi'$. The valuation $\val$ suggested by $f$ in $\pi$ verifies $\Delta^{\f}(a,\V(s)) = \Delta(a,\V(s))$, thus we can let the restriction of $\val$ to $A$ be the valuation chosen by $\exists$ in the match $\pi'$. It is immediate that any next move of $\forall$ in $\pi'$ can be mirrored by the same move in $\pi$, meaning that we are able to maintain the same position --whence the relation $(\ddag.1)$-- also in the next round.
\end{itemize}
In both cases, the suggestion of strategy $f'$ was a legitimate move for $\exists$ maintaining the relation $(\ddag)$ between the two matches for any next round $z_{i+1}$. It follows that $f'$ is a winning strategy for $\exists$ in $\mc{G}$.
%
      \begin{comment} SHORTER ALTERNATIVE VERSION OF THE PROOF
      The idea is to define a strategy $f'$ for $\exists$ in stages, while playing a match $\pi'$ in $\mathcal{A}(\aut,\model)@(a_I,s_I)$. In parallel to $\pi'$, a shadow match $\pi$ in $\mathcal{A}(\mb{A}^{\f},\model)@(a_I^{\f},s_I)$ is maintained, where $\exists$ plays according to the strategy $f$. Since $f$ is winning and all macro-states from $\shA$ have an odd parity, in finitely many rounds the shadow match $\pi$ reaches a stage where $\mb{A}^{\f}$ enters a state from $A$ and ``behaves as'' $\aut$ for all successive rounds. Thus $\pi$ can be assumed to have the following structure:
       \begin{enumerate}[(I)]
         \item there is an $n$ such that, for each round $z_i$ in the initial segment $z_0,z_1,\dots,z_n$ of $\pi$, a position of the form $(R,s) \in \shA \times T$ is visited and the valuation suggested by $f$ makes the disjunct $\shDe(R,\V(s))$ of $\Delta^{\f}(R,\V(s))$ true in $\R{s}$.
         \item At round $z_{n+1}$ a basic position of the form $(Q,t) \in \shA \times T$ is visited. The valuation suggested by $f$ makes the disjunct $\bigwedge_{a \in \Ran(R)} \Delta(a,\V(t))$ of $\Delta^{\f}(Q,\V(t))$ true in $\R{t}$. \label{point:initialsegm}
         \item For all the next rounds $z_{n+2},z_{n+3},\dots$ only positions of the form $(a,s) \in A \times T$ are visited.
       \end{enumerate}
       In each round of the initial segment $z_0,z_1,\dots,z_n$ we can maintain the condition that, if a position $(R,s)$ is visited in $\pi$, then at the same round a position $(a,s)$ with $a \in \Ran(R)$ occurs in $\pi'$. This holds for the initial round $z_0$. For the next ones $z_1,\dots,z_n$, it can be enforced by defining $f'$ in terms of $f$ in the standard way shown, for instance, in the proof of \cite[Prop. 3.9]{Zanasi:Thesis:2012}.
       \fzwarning{More details to be provided}
       Once $\pi$ reaches round $z_n$, say with position $(Q,t)$, the valuation suggested by $f$ makes $\bigwedge_{a \in \Ran(R)} \Delta(a,\V(t))$ true in $\R{t}$ ({\it cf.} point \eqref{point:initialsegm}). By assumption, at round $z_n$, $\pi'$ visits a position $(b,t)$ with $b \in \Ran(Q)$. Then in particular the valuation suggested by $f$ makes $\Delta(b,\V(t))$ true, and we let it be the suggestion of $f'$ at that stage. By definition of $\Delta^{\f}$, from the next round onwards we can maintain the same basic positions in $\pi$ and $\pi'$, and let $f'$ just be defined as $f$. As $\exists$ wins $\pi$, it will also win the match $\pi'$, meaning that $f'$ is a winning strategy.
       \end{comment}
\end{enumerate}
\end{proof}

%Details on the proof have to be provided. The idea is that the first statement is true because $\mb{A}^{\f}$ is a weak automaton and its continuity property follows by the continuity of $\mb{A}$ and Lemma \ref{LEM_cont}. The argument showing the second statement should be analogous to the one relating weak $\\val{MSO}$-automata and their two-sorted construct, see \cite[Prop. 3.9]{Zanasi:Thesis:2012}. The third statement should again follow by Lemma \ref{LEM_cont}.

\begin{remark}
While the finitary construction is a variant of the two-sorted one given
in~\cite{DBLP:conf/lics/FacchiniVZ13}, it is
worth noticing that the latter would have not been suitable for our purposes.
Indeed, suppose to define the two-sorted construct $\mb{A}^{2S}$ over a
$\wmso$-automaton $\mb{A}$, analogously to the case of weak $\MSO$-automata.
Then $\mb{A}^{2S}$ will generally \emph{not} be a $\wmso$-automaton.
The problem lies in the \textbf{(continuity)} condition: since all macro-states in
$\mb{A}^{2S}$ have parity $1$, whenever two of them, say $R$ and $Q$, are such that $R \preceq Q$ and $Q \preceq R$, then the sentence $\Delta^{2S}(R,c)$ should be continuous in $Q$. But this is not necessarily the case, since the truth of $\Delta^{2S}(R,c)$ may depend upon the truth of a subformula of the form $\exists^{\infty}x.Q(x)$, requiring $Q$ to be interpreted over infinitely many nodes. (This problem is overcome in the finitary construction by using the translation $(-)^{\f}$ to define $\Delta^{\f}$.)

As a consequence, we cannot use the two-sorted construction to show that
$\wmso$-automata are closed under noetherian projection
(\cite[Def. 3]{DBLP:conf/lics/FacchiniVZ13}).
This observation is coherent with the fact that $\nmso$ is \emph{not} a fragment of $\wmso$. Similarly, the simulation theorem for $\mso$-automata \cite{Walukiewicz96} preserves neither the \textbf{(weakness)} nor the \textbf{(continuity)} condition and thus it cannot show
closure under (arbitrary) projection for $\wmso$-automata.\end{remark} 