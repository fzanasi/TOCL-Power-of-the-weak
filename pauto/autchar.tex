In this subsection we conclude the proof of Theorem \ref{t:wmsoauto}. %, showing that $\wmso$-automata are closed under the  operations corresponding to the connectives of $\mso$, that is: union, complementation and projection with respect to finite sets.We start with the latter.

We first focus on the case of projection with respect to finite sets, which exploits our simulation result, Theorem \ref{PROP_facts_finConstrwmso}.
%%%%
%%%% PROJECTION
%%%%



\subsubsection{Closure under Finitary Projection}

\begin{definition}\label{DEF_fin_projection}
Let $\aut = \tup{A, \Delta, \Omega, a_I}$ be a $\wmso$-automaton on alphabet $\p(\prop \cup \{p\})$. Let $\aut^{\f}$
denote its finitary construct.
We define the automaton ${{\exists}_F p}.\mb{A} = \langle A^{\f}, a_I^{\f},
\DeltaProj, \Omega^{\f}\rangle$ on alphabet $\p\prop$ by putting
\begin{eqnarray*}
% \nonumber to remove numbering (before each equation)
  \DeltaProj(a,c) &:=& \Delta^{\f}(a,c) \qquad \qquadﬂ
  \DeltaProj(R,c) &:=& \Delta^{\f}(R,c) \vee \Delta^{\f}(R,c\cup\{p\}).
\end{eqnarray*}
The automaton ${{\exists}_F p}.\mb{A}$ is called the \emph{finitary projection
construct of $\mb{A}$ over $p$}.
\end{definition}

Our projection construction corresponds to a suitable closure operation on tree languages, modeling the semantics of $\wmso$ existential quantification.

\begin{definition}\label{def:tree_finproj} Let $p$ be a propositional letter and $L$ a tree language of $\p (\prop\cup\{p\})$-labeled trees. The \emph{finite projection} of $L$ over $p$ is the language ${\exists}_F p.L$ of $C$-labeled trees defined as
\begin{equation*}
    {\exists}_F p.L = \{\model \mid \text{there is a $p$-variant } \model[p\mapsto S] \text{ of } \model \text{ such that } \model[p\mapsto S] \in L \text{ and } S \text{ is finite} \}.
\end{equation*}\hfill
\end{definition}

\begin{lemma}\label{PROP_fin_projection}
For each $\wmso$-automaton $\aut$ on alphabet $\p (\prop \cup \{p\})$,
we have that
$$\trees({{\exists}_F p}.\mb{A}) \ \equiv\
{{\exists}_F p}.\trees(\mb{A}).
$$
\end{lemma}

\begin{proof}
\fcwarning{Showing this for $\aut^F$ and using Lemma~\ref{PROP_facts_finConstr}(3) leads to a way simpler proof.}What we need to show is that for any tree $\model$:
\begin{eqnarray*}
  {{\exists}_F p}.\mb{A} \text{ accepts } \mathbb{T} & \text{ iff }& \text{there is a finite $p$-variant }\model' \\
   & & \text{of }\mathbb{T}\text{  such that }\aut\text{  accepts }\model'.
\end{eqnarray*}
For direction from left to right, we first observe that the properties stated by Lemma~\ref{PROP_facts_finConstr} hold for ${{\exists}_F p}.\mb{A}$ as well, since the latter is defined in terms of $\mb{A}^{\f}$. Then we can assume that the given winning strategy $f$ for $\exists$ in $\mc{G_{\exists}} = \mc{A}({{\exists}_F p}.\mb{A},\model)@(a_I^{\f},s_I)$ is functional and finitary in $\shA$. Functionality allows us to associate with each node $s$ either none or a unique state $Q_s \in \shA$ (\emph{cf.} \cite[Prop. 3.12]{Zanasi:Thesis:2012}). We now want to isolate  the nodes that $f$ treats ``as if they were labeled with $p$''. For this purpose, let $\val_{s}$ be the valuation suggested by $f$ from a position $(Q_s,s) \in \shA \times T$. As $f$ is winning, $\val_{s}$ makes $\DeltaProj(Q,\tscolors(s))$ true in $\R{s}$. We define a $p$-variant $\model'$ of $\model$ by \fcwarning{Why the tilde?}coloring with $p$ all nodes in the following set:
 \begin{equation}\label{eq:X_p}
% \nonumber to remove numbering (before each equation)
   X_p\ :=\ \{s \in T\mid (\R{s},\widetilde{\val}_{s}) \models \Delta^{\f}(Q_s,\tscolors(s)\cup\{p\})\}.
\end{equation}
The fact that the strategy of $\exists$ is finitary in $\shA$ guarantees that $X_p$ is finite, whence $\model'$ is a finite $p$-variant. The argument showing that $\mb{A}^{\f}$ (and thus also $\mb{A}$, by Lemma~\ref{PROP_facts_finConstr}(1))\fcwarning{isn't this (3)?} accepts $\model'$ is a routine adaptation of the analogous proof for the noetherian projection of weak $\mso$-automata, for which we refer to \cite[Prop. 3.12]{Zanasi:Thesis:2012}.
\medskip

For the direction from right to left, let $\model'$ be a finite $p$-variant of
$\model$, with labeling function $\tscolors'$, and $g$ a winning strategy for $\exists$ in $\mc{G} = \mathcal{A}(\aut,\model')@(a_I,s_I)$. Our goal is to define a strategy $g'$ for $\exists$ in $\mc{G_{\exists}}$. As usual, $g'$ will be constructed in stages, while playing a match $\pi'$ in $\mc{G_{\exists}}$. In parallel to $\pi'$, a \emph{bundle} $\mc{B}$ of $g$-guided shadow matches in $\mc{G}$ is maintained, with the following condition enforced for each round $z_i$ (\emph{cf.} \cite[Prop.~ 3.12]{Zanasi:Thesis:2012}) :
\smallskip
\begin{center}
\fbox{\parbox{13cm}{
\begin{enumerate}
  \item If the current (i.e. at round $z_i$) basic position in $\pi'$ is of the form $(Q,s) \in \shA \times T$, then for each $a \in\Ran(Q)$ there is an $g$-guided (partial) shadow match $\pi_a$ at basic position $(a,s) \in A\times T$ in the current bundle $\mc{B}_i$. Also, either $\model'_s$ is not $p$-free (i.e., it does contain a node $s'$ with $p \in \tscolors'(s')$) or $s$ has some sibling $t$ such that $\model'_t$ is not $p$-free.
  \item Otherwise, the current basic position in $\pi'$ is of the form $(a,s) \in A \times T$ and $\model'_s$ is $p$-free (i.e., it does not contain any node $s'$ with $p \in \tscolors'(s')$). Also, the bundle $\mc{B}_i$ only consists of a single $g$-guided match $\pi_a$ whose current basic position is also $(a,s)$.
\end{enumerate}
}}\hspace*{0.3cm}($\ddag$)
\end{center}
\smallskip
We briefly recall the idea behind condition ($\ddag$). Point ($\ddag.1$) describes the part of match $\pi'$ where it is still possible to encounter nodes which are labeled with $p$ in $\model'$. As $\DeltaProj$ only takes the letter $p$ into account when defined on macro-states in $\shA$, we want $\pi'$ to visit only positions of the form $(R,s) \in \shA \times T$ in that situation. Anytime we visit such a position $(R,s)$ in $\pi'$, the role of the bundle is to provide one $g$-guided shadow match at position $(a,s)$ for each $a \in \Ran(R)$.
Then $g'$ is defined in terms of what $g$ suggests from those positions.

 Point ($\ddag.2$) describes how we want the match $\pi'$ to be
 played on a $p$-free subtree: as any node that one might encounter has the same label in $\model$ and $\model'$,
it is safe to let ${{\exists}_F p}.\mb{A}$ behave as $\aut$ in such situation. Provided that the two matches visit the same basic positions, of the form $(a,s)\times A \times T$, we can let $g'$ just copy $g$.

The key observation is that, as $\model'$ is a \emph{finite} $p$-variant of $\model$, nodes labeled with $p$ are reachable only for finitely many rounds of $\pi'$. This means that, provided that ($\ddag$) hold at each round, ($\ddag.1$) will describe an initial segment of $\pi'$, whereas ($\ddag.2$) will describe the remaining part. Thus our proof that $g'$ is a winning strategy for $\exists$ in $\mc{G}_{\exists}$ is concluded by showing that ($\ddag$) holds for each stage of construction of $\pi'$ and $\mc{B}$.

\medskip

For this purpose, we initialize $\pi'$ from position $(\shai,s) \in \shA\times T$ and the bundle $\mc{B}$ as $\mc{B}_0 = \{\pi_{a_I}\}$, with $\pi_{a_I}$ the partial $g$-guided match consisting only of the position $(a_I,s)\in A\times T$. The situation described by ($\ddag .1$) holds at the initial stage of the construction.
Inductively, suppose that at round $z_i$ we are given a position $(q,s) \in A^{\f} \times T$ in $\pi^{\f}$ and a bundle $\mc{B}_i$ as in ($\ddag$). To show that ($\ddag$) can be maintained at round $z_{i+1}$, we distinguish two cases, corresponding respectively to situation ($\ddag.1$) and ($\ddag.2$) holding at round $z_i$.
\begin{enumerate}[label = (\Alph*), ref = \Alph*]
%\yvwarning{Notation `$q$' is confusing, see $\val'(q)$ below FZ: I corrected $q$ into $q'$ below}
  \item If $(q,s)$ is of the form $(Q,s) \in \shA \times T$, by inductive hypothesis we are given with $g$-guided shadow matches $\{\pi_a\}_{a \in \Ran(Q)}$ in $\mc{B}_i$. For each match $\pi_a$ in the bundle, we are provided with a valuation $\val_{a,s}: A \rightarrow \p (\R{s})$ making $\Delta(a,\tscolors'(s))$ true. Then we further distinguish the following two cases.
\begin{enumerate}[label = (\roman*), ref = \roman*]
  \item \label{point:TsNotPFree} Suppose first that $\model'_s$ is not $p$-free. We let the suggestion $\val' \: A^{\f} \to \p (\R{s})$ of $g'$ from position $(Q,s)$ be defined as follows:
       \begin{align*}
       % \nonumber to remove numbering (before each equation)
       %\widetilde{\val}_{Q,s}(Q') &:=& \bigcup_{a \in \Ran(Q),\ b \in \Ran(Q')}\{t\ \in \R{s}|\ t \in \val_{a,s}(b)\}.
       \val'(q')\ :=\ \begin{cases}
               \bigcap\limits_{\substack{(a,b) \in q',\\ a \in \Ran(Q)}}\{t\ \in \R{s} \mid t \in \val_{a,s}(b)\}               & q' \in \shA \\[2em]
               \bigcup\limits_{a \in \Ran(Q)} \{t\ \in \R{s} \mid t \in \val_{a,s}(q') \text{ and }\model'.t\text{ is $p$-free}\}              & q' \in A.
               %\\[1.5em]               \hspace{.6cm}\emptyset & \text{otherwise.}
           \end{cases}
       \end{align*}
       The definition of $\val'$ on $q' \in \shA$ is standard (\emph{cf.}~\cite[Prop. 2.21]{Zanasi:Thesis:2012}) and guarantees a correspondence between the states assigned by the markings $\{\val_{a,s}\}_{a \in \Ran(Q)}$ and the macro-states assigned by $\val'$. The definition of $\val'$ on $q' \in A$ aims at fulfilling the conditions, expressed via $\qu$ and $\dqu$, on the number of nodes in $\R{s}$ witnessing (or not) some $A$-types. Those conditions are the ones that $\shDe(Q,\tscolors'(s))$ --and thus also $\Delta^{\f}(Q,\tscolors'(s))$-- ``inherits'' by $\bigwedge_{a \in \Ran(R)} \Delta(a,\tscolors'(s))$, by definition of $\shDe$. Notice that we restrict $\val'(q')$ to the nodes $t \in \val_{a,s}(q')$ such that $\model'.t$ is $p$-free. As $\model'$ is a \emph{finite} $p$-variant, only \emph{finitely many} nodes in $\val_{a,s}(q')$ will not have this property. Therefore their exclusion, which is crucial for maintaining condition ($\ddag$) (\emph{cf.}~case \eqref{point:ddag2CardfromMacro} below), does not influence the fulfilling of the cardinality conditions expressed via $\qu$ and $\dqu$ in $\shDe(Q,\tscolors'(s))$.

       On the base of these observations, one can check that $\val'$ makes $\shDe(Q,\tscolors'(s))$--and thus also $\Delta^{\f}(Q,\tscolors'(s))$--true in $\R{s}$. In fact, to be a legitimate move for $\exists$ in $\pi'$, $\val'$ should make $\DeltaProj(Q,\tscolors(s))$ true: this is the case, for $\Delta^{\f}(Q,\tscolors'(s))$ is either equal to $\Delta^{\f}(Q,\tscolors(s))$, if $p \not\in \tscolors'(s)$, or to $\Delta^{\f}(Q,\tscolors(s)\cup\{p\})$ otherwise. In order to check that we can maintain $(\ddag)$, let $(q',t) \in A^{\f} \times T$ be any next position picked by $\forall$ in $\pi'$ at round $z_{i+1}$. As before, we distinguish two cases:
       \begin{enumerate}[label = (\alph*), ref = \alph*]
         \item If $q'$ is in $A$, then, by definition of $\val'$, $\forall$ can choose $(q',t)$ in some shadow match $\pi_a$ in the bundle $\mc{B}_i$. We dismiss the bundle --i.e. make it a singleton-- and bring only $\pi_a$ to the next round in the same position $(q',t)$. Observe that, by definition of $\val'$, $\model'.t$ is $p$-free and thus ($\ddag.2$) holds at round $z_{i+1}$. \label{point:ddag2CardfromMacro}
         \item Otherwise, $q'$ is in $\shA$. The new bundle $\mc{B}_{i+1}$ is given in terms of the bundle $\mc{B}_i$: for each $\pi_a \in \mc{B}_i$ with $a\in \Ran(Q)$, we look if for some $b \in \Ran(q')$ the position $(b,t)$ is a legitimate move for $\forall$ at round $z_{i+1}$; if so, then we bring $\pi_a$ to round $z_{i+1}$ at position $(b,t)$ and put the resulting (partial) shadow match $\pi_b$ in $\mc{B}_{i+1}$. Observe that, if $\forall$ is able to pick such position $(q',t)$ in $\pi'$, then by definition of $\val'$ the new bundle $\mc{B}_{i+1}$ is non-empty and consists of an $g$-guided (partial) shadow match $\pi_b$ for each $b \in \Ran(q')$. In this way we are able to keep condition ($\ddag.1$) at round $z_{i+1}$.
       \end{enumerate}
    \item Let us now consider the case in which $\model'_s$ is $p$-free. We let $g'$ suggest the valuation $\val'$ that assigns to each node $t \in \R{s}$ all states in $\bigcup_{a \in \Ran(Q)}\{b \in A\ |\ t \in \val_{a,s}(b)\}$. It can be checked that $\val'$ makes $\bigwedge_{a \in \Ran(Q)} \Delta(a,\tscolors'(s))$ -- and then also $\Delta^{\f}(Q,\tscolors'(s))$ -- true in $\R{s}$. As $p \not\in \tscolors(s)=\tscolors'(s)$, it follows that $\val'$ also makes $\DeltaProj(Q,\tscolors(s))$ true, whence it is a legitimate choice for $\exists$ in $\pi'$. Any next basic position picked by $\forall$ in $\pi'$ is of the form $(b,t) \in A \times T$, and thus condition ($\ddag.2$) holds at round $z_{i+1}$ as shown in (i.a). %\eqref{point:ddag2CardfromMacro}
  \end{enumerate}
  \item In the remaining case, $(q,s)$ is of the form $(a,s) \in A \times T$ and by inductive hypothesis we are given with a bundle $\mc{B}_i$ consisting of a single $f$-guided (partial) shadow match $\pi_a$ at the same position $(a,s)$. Let $\val_{a,s}$ be the suggestion of $\exists$ from position $(a,s)$ in $\pi_a$. Since by assumption $s$ is $p$-free, we have that $\tscolors'(s) = \tscolors(s)$, meaning that $\DeltaProj(a,\tscolors(s))$ is just $\Delta(a,\tscolors(s)) = \Delta(a,\tscolors'(s))$. Thus the restriction $\val'$ of $\val$ to $A$ makes $\Delta(a,\tscolors'(t))$ true and we let it be the choice for $\exists$ in $\tilde{\pi}$. It follows that any next move made by $\forall$ in $\tilde{\pi}$ can be mirrored by $\forall$ in the shadow match $\pi_a$.
      \begin{comment}Version with minimality:
      It follows that $\DeltaProj(a,\tscolors(t))$ is just $\Delta(a,\tscolors(t)) = \Delta(a,\tscolors'(t))$ and the same valuation suggested by $f$ in $\pi_a$ is a legitimate choice for $\exists$ in $\tilde{\pi}$. By letting $\exists$ choose such valuation, it follows that any next move made by $\forall$ in $\tilde{\pi}$ can be mirrored by $\forall$ in the shadow match $\pi_a$.
      \end{comment}
\end{enumerate}

%As explained above, since $\model'$ is a noetherian $p$-variant, then ($\ddag .1$) holds for finitely many stages of construction of $\tilde{\pi}$, whereas ($\ddag .2$) holds for all the remaining stages, by construction of $\tilde{f}$. It follows that this strategy is winning for $\exists$ in $\tilde{G}$.

\end{proof} 

%%%%%%
%%%%%% BOOLEANS
%%%%%%

\subsubsection{Closure under Boolean operations}

In this section we will show that the class of $\wmso$-automaton recognizable
tree languages is closed under the Boolean operations.
%
Start with closure under union, we just mention the following result, without
providing the (completely routine) proof.

\begin{theorem}
\label{t:cl-dis}
Let $\bbA_{0}$ and $\bbA_{1}$ be $\wmso$-automata. 
Then there is a $\wmso$-automaton $\bbA$ such that $\trees(\bbA)$ is the 
union of $\trees(\bbA_{0})$ and $\trees(\bbA_{1})$.
\end{theorem}

In order to prove closure under complementation, we crucially use that the 
one-step language $\olque$ is closed under Boolean duals.

\myparagraphns{Closure under complementation.}
Many properties of parity automata can already be determined at the one-step level.
An important example concerns the notion of complementation.


\begin{definition}
\label{d:bdual1}
Two one-step formulas $\varphi$ and $\psi$ are each other's \emph{Boolean dual}
if for every structure $(D,\val)$ we have:
\[
(D,\val) \models \varphi \quad\text{iff}\quad (D,\val^{c}) \not\models \psi,
\]
where $\val^{c}$ is the valuation given by $\val^{c}(a) \mathrel{:=} D
\setminus \val(a)$, for all $a$.
%
A one-step language $\llang$ is \emph{closed under Boolean duals} if for every
set $A$, each formula $\varphi \in \llang(A)$ has a Boolean dual $\dual{\varphi}
\in \llang(A)$.
\end{definition}

Following ideas from~\cite{Muller1987,DBLP:conf/calco/KissigV09}, we can use Boolean duals, together with a
\emph{role switch} between $\abelard$ and $\eloise$, in order to define a
negation or complementation operation on automata.

\begin{definition}
\label{d:caut}
Assume that, for some one-step language $\llang$, the map $\dual{(-)}$
provides, for each set $A$, a Boolean dual $\dual{\varphi} \in \llang(A)$ for each
$\varphi \in \llang(A)$.
Given $\aut = \tup{A,\tmap,\pmap,a_I}$ in $\Aut(\llang)$ we define its
\emph{complement} $\dual{\aut}$ as the automaton
$\tup{A,\dual{\tmap},\dual{\pmap},a_I}$
where $\dual{\tmap}(a,c) := \dual{(\tmap(a,c))}$, and $\dual{\pmap}(a)
:= 1 + \pmap(a)$, for all $a \in A$ and $c \in \wp(\props)$.
\end{definition}

\begin{proposition}
\label{prop:autcomplementation}
Let $\llang$ and $\dual{(-)}$ be as in the previous definition.
For each automaton $\aut \in \Aut(\llang)$ and each transition system
$\model$ we have that
\[
\dual{\aut} \text{ accepts } \model
\quad\text{iff}\quad
\aut \text{ rejects } \model.
\]
\end{proposition}

The proof of Proposition~\ref{prop:autcomplementation} is based on the fact
that the power of $\eloise$ in $\agame(\dual{\aut},\model)$ is the same
as that of $\abelard$ in $\agame(\aut,\model)$, as defined in~\cite{DBLP:conf/calco/KissigV09}.

As an immediate consequence of this proposition, one may show that if the
one-step language $\llang$ is closed under Boolean duals, then the class
$\Aut(\llang)$ is closed under taking complementation.
Further on we will use Proposition~\ref{prop:autcomplementation} to show that
the same may apply to some subclasses of $\Aut(\llang)$.


\begin{theorem}
\label{t:cl-cmp}
Let $\bbA$ be an $\wmso$-automaton.
Then the automaton $\overline{\aut}$ defined in Definition~\ref{d:caut} is a
$\wmso$-automaton recognizing the complement of $\trees(\bbA)$.
\end{theorem}

\begin{proof}
Since we already know that $\overline{\bbA}$ accepts exactly the transition
systems that are rejected by $\bbA$, we only need to check that 
$\overline{\bbA}$ is indeed a $\wmso$-automaton.
But this is straightforward: for instance, continuity can be checked by 
observing the self-dual nature of this property.
\end{proof}


%%%%
%%%% PROOF THEOREM
%%%%

\subsection{Proof of Theorem \ref{t:wmsoauto}}

\begin{proof} The proof is by induction on $\varphi$.
\begin{itemize}
  \item For the base case $\varphi = p \inc q$, the corresponding 
  $\wmso$-automaton is provided in \cite[Ex. 2.6]{Zanasi:Thesis:2012}. 
  For the base case $\varphi = R(p,q)$, we give the corresponding 
  $\wmso$-automaton $\aut_{R(p,q)} = \tup{A,\Delta,\Omega,a_I}$ below:
\begin{eqnarray*}
        A &:=& \{a_0,a_1\}\\
        a_I &:=& a_0\\
  \Delta(a_0,c) &:=& \left\{
	\begin{array}{ll}
           \exists x. a_1(x) \wedge \forall y. a_0(y) & \mbox{if }p \in c 
	\\ \forall x\ (a_0(x)) & \mbox{otherwise}
	\end{array}
\right. \\
  \Delta(a_1,c) &:=& \left\{
	\begin{array}{ll}
        \top & \mbox{if }q \in c \\
        \bot & \mbox{otherwise}
	\end{array}
\right. \\
    \Omega(a_0) &:=& 0\\
    \Omega(a_1) &:=& 1.
\end{eqnarray*}
Note that the $\mso$-automaton for $R(p,q)$ provided in 
\cite[Ex. 2.5]{Zanasi:Thesis:2012} is \emph{not} a $\wmso$-automaton, as the 
continuity property does not hold.

\item
For the Boolean cases, where $\varphi = \psi_1 \vee \psi_2$ or $\phi = \neg\psi$
we refer to the closure properties of recognizable tree languages, see 
Theorem~\ref{t:cl-dis} and Theorem~\ref{t:cl-cmp}, 
respectivel.
  
\item 
For the case $\varphi = \exists p. \psi$, consider the following chain of
equivalences, where $\aut_{\psi}$ is given by the inductive hypothesis and 
${{\exists}_F p}.\aut_{\psi}$ is constructed according to 
Definition \ref{DEF_fin_projection}:
\begin{alignat*}{2}
{{\exists}_F p}.\aut_{\psi} \text{ accepts }\mb{T} 
   & \text{ iff }
     \aut_{\psi} \text{ accepts } \mb{T}[p \mapsto X], 
     \text{ for some } X \sse_{\om} T
   & \quad\text{(Lemma~\ref{PROP_fin_projection})}
\\ & \text{ iff }
     \mb{T}[p \mapsto X] \models \psi,
     \text{ for some } X \sse_{\om} T
   & \quad\text{(induction hyp.)}
\\ & \text{ iff }
    \mb{T} \models \exists p. \psi
   & \quad\text{(semantics $\wmso$)}
\end{alignat*}
\end{itemize}
\end{proof}

