%!TEX root = ../00CFVZ_TOCL.tex


In this subsection we work with the members of the class $\AutWC(\olque)$, which we henceforth call \emph{$\wmso$-automata}. Whereas continuity has been abstractly formulated as a \emph{semantic} condition, thanks to Theorem XXX \fznote{theorem about syntactic char. for continuity} we can work with a completely syntactic definition of $\wmso$-automata, \emph{(continuity)} for $\llang = \ofoe$ being equivalently to the following condition. 
\begin{description}
	\itemsep 0 pt
	\item[(continuity, syntactically)] if $\pmap(a)$ is odd (resp. even) then, for each $c\in C$ we have
	   $\tmap(a,c) \in \cont{{\olque}^+}{b}(A)$ (resp. $\tmap(a,c) \in \cocont{{\olque}^+}{b}(A)$).
\end{description} 

In the remainder of this subsection we prove the following result, yielding the direction from formulas to automata of the characterisation theorem for $\wmso$.

\begin{theorem}
\label{t:wmsoauto}
There is an effective construction transforming a $\wmso$-formula $\phi$
into a $\wmso$-automaton $\bbA_{\phi}$ that is equivalent
to $\phi$ on the class of trees.
That is, for any tree $\bbT$, $\bbA_{\phi}$ accepts $\bbT$ if and only if $\bbT \models {\phi}$.
\end{theorem}

The proof proceeds by induction on the complexity of
$\phi$. For the inductive steps, we will need to verify that the class of
$\wmso$-automata is closed under the boolean operations and finite projection.
The latter closure property requires most of the work: we devote Section \ref{sec:simulationwmso} to a simulation theorem that put $\wmso$-automata in a suitable shape
for the projection construction.
%
To this aim, it is convenient to define a closure operation on tree languages corresponding
to the semantics of $\wmso$ quantification. The inductive step of the proof of Theorem \ref{t:wmsoauto} will show that tree languages accepted by $\wmso$-automata are closed under this operation.

\begin{definition}\label{def:tree_finproj}
Fix a set $\prop$ of proposition letters, $p \not\in P$ and a language $\trees$ of $\p (\prop\cup\{p\})$-labeled
trees.
The \emph{finitary projection} of $\trees$ over $p$ is the language
${\finexists}_F p.\trees$ of $\p (\prop)$-labeled trees
given as follows:
%
$$
{\finexists}_F p.\trees = \{\model \mid \text{ $\exists$ a finite $p$-variant } \model' \text{ of } \model \text{ with } \model' \in \trees\}.
$$
%
A class $K$ of tree languages is \emph{closed under finitary projection
over $p$} if, for any language $\trees$ in $K$, also ${{\finexists}_F p}.\trees$ is in $K$.
\end{definition} 



\subsubsection{Simulation theorem for $\wmso$-automata}\label{sec:simulationwmso}

\noindent Our next goal is a \emph{projection construction} that, given
a $\wmso$-automaton $\mb{A}$, provides one recognizing ${{\exists}_F p}.\trees(\mb{A})$. For $\mso$-automata, an analogous construction crucially uses the following \emph{simulation theorem}: every
$\mso$-automaton $\aut$ is equivalent to a \emph{non-deterministic} one $\aut'$ \cite{Walukiewicz96}.
Semantically, non-determinism yields the appealing property that every node of the input model $\model$ is associated with at most one state of $\aut'$ during the acceptance game--- that means, $\eloise$'s strategy $f$ in $\agame(\aut',\model)$ is \emph{functional} (\emph{cf.} Definition \ref{def:StratfunctionalFinitary} below). This is particularly helpful because, to define a $p$-variant of $\model$
that is accepted by the projection construct on $\aut'$, we
can infer whether a node $s$ should be labeled with $p$ by the value $f(a,s)$, where $a$ is the unique state of $\aut'$ (by functionality) that $f$ associates with $s$. Now, in the case of $\wmso$-automata we are interested in guessing
\emph{finitary} $p$-variants, which requires $f$ to be functional only on a \emph{finite} set of nodes. Thus the idea of our simulation theorem is to turn a $\wmso$-automaton $\aut$ into an equivalent one $\aut^{\f}$ that behaves non-deterministically on a \emph{finite} portion of any accepted tree.

For $\mso$-automata, the simulation theorem is based on a powerset construction: if the starting automaton has carrier $A$, the resulting non-deterministic automaton is based on ``macro-states'' from the set $\shA := \pw (A \times A)$.\footnote{The use of carrier $\pw (A \times A)$ instead of the more obvious $\pw A$ is needed to correctly associate with a run on macro-states the corresponding bundle of runs of the original automaton $\aut$ (\emph{cf.} \cite{Walukiewicz96}).} Analogously, for $\wmso$-automata we will associate the non-deterministic behavior with macro-states. However, as explained above, the automaton $\aut^{\f}$ that we construct has to be non-deterministic just on finitely many nodes of the input and may behave as $\aut$ (i.e. in ``alternating mode'') on the others. To this aim, $\aut^{\f}$ will be ``two-sorted'', roughly consisting of one copy of $\aut$ (with carrier $A$) and a variant of its powerset construction, based both on $A$ and $\shA$. For any accepted $\model$, the idea is to make any match $\pi$ of $\mc{A}(\aut^{\f},\model)$ consist of two parts:
\begin{description}
  \item[(\textbf{Non-deterministic mode})] for finitely many rounds $\pi$ is played on macro-states, i.e. positions are of the form $\shA \times T$. In her strategy player $\exists$ assigns macro-states (from $\shA$) only to \emph{finitely many} nodes, and states (from $A$) to the rest. Also, her strategy is functional in $\shA$, i.e. it assigns \emph{at most one macro-state} to each node.
  \item[(\textbf{Alternating mode})] At a certain round, $\pi$ abandons macro-states and turns into a match of the game $\mc{A}(\aut,\model)$, i.e. all next positions are from $A \times T$ (and are played according to a non-necessarily functional strategy). %of shape $(a,t) \in A \times T$.
\end{description}
Therefore successful runs of $\aut^{\noet}$ will have the property of processing only a \emph{finite} amount of the input with $\aut^{\noet}$ being in a macro-state and all the rest with $\aut^{\noet}$ behaving exactly as $\aut$. We now proceed in steps towards the construction of $\aut^{\noet}$. The following is a notion of lifting for types on states that is instrumental in defining a translation to types on macro-states. The distinction between empty and non-empty subsets of $A$ is to make sure that empty types on $A$ are lifted to empty types on $\pw A$.
\begin{definition}
Given a set $A$ and $\Sigma \subseteq \wp A$, we define the \emph{lifting} $\lift{\Sigma} \subseteq \wp \wp A$ as $\{\{S\} \mid S \in \Sigma \wedge S \neq \emptyset\} \cup
    \{\emptyset \mid \emptyset \in \Sigma \}$.
\end{definition}

Next we define a translation on the sentences associated with the
transition function of the original $\wmso$-automaton. Following the intuition given above, we want to work with sentences that can be made true by assigning macro-states (from $\shA$) to finitely many nodes in the model, and ordinary states (from $A$) to all the other nodes. 

\begin{definition}\label{DEF_finitary_lifting}
Let $\varphi \in {\olque}^+(A \times A)$ be a formula of shape $\posdbnfofoei{\vlist{T}}{\Pi}{\Sigma}$ for some $\Pi,\Sigma \subseteq \shA$ and $\vlist{T} = \{T_1,\dots,T_k\} \subseteq \shA$. Fix $\widetilde{\Sigma} \df \{\Ran(S) \mid S \in \Sigma\} \subseteq \wp A$. We define $\varphi^{\fin} \in {\olque}^+(A \cup \shA)$ as $\posdbnfofoei{\lift{\vlist{T}}}{\lift{\Pi} \cup \lift{\Sigma}}{\widetilde{\Sigma}}$\end{definition}

We refer to \eqref{eq:unfoldingNablaolque} below for the unfolding of the expression $\varphi^{\fin}$. Observe that each ${\tau}^{+}_{P}$ with $P \in \widetilde{\Sigma}$ appearing in $\varphi^{\fin}$ is a (positive) $A$-type, as $P = \Ran(S) \subseteq A$ for some $S \in \Sigma$. Our desiderata on this translation concern the notions of \emph{continuity} and \emph{functionality}.
%The idea of translation $(\cdot)^{\noet}$ is to encode at the one-step level the non-deterministic mode of $\aut^{\noet}$: the property to enforce is that $\varphi^{\noet}$ is \emph{functional} in $\shA$, that means, whenever $(D,\val \: A \to \wp(D)) \models \varphi^{\noet}$, then there is $\val'  \: A \to \wp(D)$ such that $(D, \val') \models \varphi^{\noet}$ and  $ \val'(q_1)\cap \val'(q_2) = \emptyset$ for all $q_1,q_2 \in \shA$. 

\begin{definition} Given a set $A$ of unary predicates and $B \subseteq A$, we say that a sentence $\varphi \in {\olque}^+(A)$ is \emph{functionally continuous in $B$} if, for every model $(D,\val \: A \to \wp(D))$,
\begin{align*}
\text{if } (D,\val),\ass \models \varphi \text{ then } & \exists\ \val' \: A \to \wp(D) \text{ such that } (D, \val'),\ass \models \varphi, \\
& \val'(a)\subseteq \val(a) \text{ for all } a \in A, \tag{$\val'$ is a restriction of $\val$}\\
 & \val'(b) \text{ is finite for all }b \in B \text{ and } \tag{continuity in $B$}\\
 & \val'(b)\cap \val'(a) = \emptyset \text{ for all } a \in A\setminus\{b\} \text{ and }b \in B\tag{functionality in $B$}.
\end{align*}
%Moreover, $\varphi$ is \emph{functionally continuous in $B \subseteq A$} if it is so for each $b \in B$.
\end{definition}
In words, $\varphi$ is functionally continuous in $B$ if it is continuous in each $b \in B$ and, for each model $(D,\val)$ where $\varphi$ is true, there is a restriction $\val'$ of $\val$ which both witnesses continuity and does not assign any other $a \in A$ to elements marked with some $b \in B$.
\begin{lemma}\label{LEM_cont}
Let $\varphi \in {\olque}^+(A \times A)$ and $\varphi^{\fin}\in {\olque}^+(A\cup \shA )$ be given as in Definition~\ref{DEF_finitary_lifting}. Then $\varphi^{\fin}$ is functionally continuous in $\shA$.
 \end{lemma}

\begin{proof}
%\yvwarning{this proof could use some more detail FZ: I expanded the proof and tried to make it clearer}
We first unfold the definition of $\varphi^{\fin}$ as follows:
\begin{equation}\label{eq:unfoldingNablaolque}
\begin{aligned}
\varphi^{\fin} =\ &
\underbrace{
    \exists \vlist{x}.\big(\arediff{\vlist{x}} \land \bigwedge_{0 \leq i \leq n} \tau^+_{\lift{T}_i}(x_i)
}_{\psi_1}
\land \underbrace{
    \forall z.(\arediff{\vlist{x},z} \lthen \bigvee_{S\in \lift{\Pi} \cup \lift{\Sigma} \cup \widetilde{\Sigma}} \tau^+_S(z))\big)
}_{\psi_2}
\land
\\ & \underbrace{
    \bigwedge_{P\in\widetilde{\Sigma}} \qu y.{\tau}^{+}_P(y)
}_{\psi_3} \land
 \underbrace{
    \dqu y.\bigvee_{P\in\widetilde{\Sigma}} {\tau}^{+}_P(y)
}_{\psi_4} .
\end{aligned}
\end{equation}
Observe that $\psi_1 \land \psi_2$ is just $\mondbnfofoe{\lift{\vlist{T}}}{\lift{\Pi} \cup \lift{\Sigma} \cup \widetilde{\Sigma}}{+}$. Now suppose that $(D,\val \: (A \cup \shA ) \to \wp(D))$ is a model where $\varphi^{\fin}$ is true. This amounts to the truth of subformulas $\psi_1$, $\psi_2$, $\psi_3$ and $\psi_4$ whose syntactic shape yields information on the types of elements of $D$. In particular, we can define a partition of $D$ into subsets $D_1$, $D_2$, $D'_2$ as follows:
\begin{itemize}
  \item As $\psi_1$ is true, we can pick $n$ distinct elements $s_1,\dots,s_n$ of $D$ such that $s_i$ witnesses the positive type $\lift{T}_i$, %\tau^+_{\lift{T}_i}(x_i)$,
   that is, $s_i \in \val(S)$ for each $S \in \lift{T}_i$. We define $D_1 := \{s_1,\dots,s_n\}$.
  %
  \item  As $\psi_2$ is true, we can cover all the elements not in $D_1$ with two disjoint sets $D_2$ and $D'_2$ given as follows. The set $D_2$ is defined to contain all the elements not in $D_1$ witnessing a type ${\tau}^{+}_P(z)$ with $P \in \widetilde{\Sigma}$. The set $D'_2$ is just the complement of $D_1 \cup D_2$: by syntactic shape of $\psi_2$, all elements of $D'_2$ witness a positive type ${\tau}^{+}_S$ with
  $S \in \lift{\Pi} \cup \lift{\Sigma}$.
  %
  \item The truth of the subformula $\psi_4$ yields the information that the set $D_1 \cup D'_2$ is finite. If $\widetilde{\Sigma}$ is non-empty, the truth of $\psi_3$ implies that the set $D_2$ is infinite.
 \end{itemize}
This partition uniquely associates with each $s \in D$ a type ${\tau}^{+}_S$ witnessed by $s$ and thus a set of unary predicates $S_s := S \subseteq A \cup \shA$. We can then define a valuation $\val'$ assigning to each element $s$ of $D$ exactly the set $S_s$.

We now check the properties of $\val'$. As the partition inducing $\val'$ follows the syntactic shape of $\varphi^{\fin}$, one can observe that $\val'$ is a restriction of $\val$ and $(D,\val')$ makes $\varphi^{\fin}$ true. By definition of the partition, $\val'$ assigns unary predicates from $\shA$ only to elements in the finite set $D_1 \cup D'_2$, meaning that $\varphi^{\fin}$ is continuous in $\shA$. Furthermore, $\val'$ assigns at most one unary predicate from $\shA$ to each element of $D_1 \cup D'_2$, because $\lift{\vlist{T}} \cup \lift{\Pi} \cup \lift{\Sigma}$ is defined as the lifting of $\vlist{T} \cup \Pi \cup \Sigma$. It follows that $\varphi^{\fin}$ is also functional in $\shA$. Since the same restriction $\val'$ yields both properties, $\varphi^{\fin}$ is functionally continuous in $\shA$.
\end{proof}

\begin{remark} As $\varphi^{\fin}$ is of shape $\posdbnfofoei{\lift{\vlist{T}}}{\lift{\Pi} \cup \lift{\Sigma}}{\widetilde{\Sigma}}$ with $R \not\in \bigcup\widetilde{\Sigma}$ for each $R \in \shA$, by application of Corollary \ref{cor:olquecontinuousnf} we would immediately get that $\varphi^{\fin}$ is continuous in each $R \in \shA$. However, in proving Lemma \ref{LEM_cont} we privileged a direct proof allowing to show both continuity and functionality at once.
\end{remark}

The next definition is standard (see e.g.  \cite{Walukiewicz96,Ven08}) as an intermediate step to define the transition function of the powerset construct for parity automata.

\begin{definition}\label{DEF_delta star} Let $\aut = \tup{A,\tmap,\pmap,a_I}$ be a $\wmso$-automaton. Fix $a \in A$ and $c \in C$. We define $\tmap^{\star}(a,c) \df \tmap(a,c)[b \mapsto (a,b) \mid b \in A]$, that is, the sentence in ${\olque}^+(A\times A)$ obtained by replacing each occurrence of an unary predicate $b \in A$ in $\tmap(a,c)$ with the unary predicate $(a,b) \in A \times A$. \end{definition}

 Next we combine the previous definitions to characterise the transition function associated with the macro-states.

\begin{definition}\label{PROP_DeltaPowerset}
Let $\aut = \tup{A,\tmap,\pmap,a_I}$ be a $\wmso$-automaton. Let $c \in C$ be a label and $Q \in \shA$ a binary relation on $A$. By Corollary \ref{cor:olquepositivenf}, for some $\Pi,\Sigma \subseteq \shA$ and $T_i \subseteq A \times A$, there is a sentence $\Psi_{Q,c} \in {\olque}^+(A\times A)$ in the basic form $\bigvee \posdbnfofoei{\vlist{T}}{\Pi}{\Sigma}$ such that
\begin{eqnarray*}
% \nonumber to remove numbering (before each equation)
  \bigwedge_{a \in \Ran(Q)} \tmap^{\star}(a,c) &\equiv& \Psi_{Q,c}.
\end{eqnarray*}
By definition $\Psi_{Q,c}$ is of the form $\bigvee_{i}\varphi_i$, with each $\phi_{i}$ of shape $\posdbnfofoei{\vlist{T}}{\Pi}{\Sigma}$. We put $\shDe(Q,c) := \bigvee_{i}\varphi_i^{\fin}$, where the translation $(-)^{\fin}$ is given as in Definition~\ref{DEF_finitary_lifting}. Observe that $\shDe(Q,c)$ is of type ${\olque}^+(A \cup \shA)$.
\end{definition}

We have now all the ingredients to define our two-sorted automaton.

\begin{definition}\label{def:finitaryconstruct}
Let $\aut = \tup{A,\tmap,\pmap,a_I}$ be a {\wmso-automaton}. We define the \emph{finitary construct over $\aut$} as the automaton $\aut^{\fin} = \tup{A^{\fin},\tmap^{\fin},\pmap^{\fin},a_I^{\fin}}$ given by
\begin{eqnarray*}
      % \nonumber to remove numbering (before each equation)
        A^{\fin} &:=& A \cup \shA \\
        %\leq^{2S} &:=& \leq\ \cup\ (\shA \times A)\ \cup\ (\shA \times \shA)\\
        a_I^{\fin} &:=& \{(a_I,a_I)\}\\
        \tmap^{\fin}(a,c) &:=& \tmap(a,c)\\
        \tmap^{\fin}(R,c) &:=& \shDe(R,c) \vee \bigwedge_{a \in \Ran(R)} \tmap(a,c)\\
        \pmap^{\fin}(a) &:=& \pmap(a)\\
        \pmap^{\fin}(R) &:=& 1.
      \end{eqnarray*}
\end{definition}

The idea behind this definition is that $\aut^{\fin}$ is enforced to process only a finite portion of any accepted tree while in the non-deterministic mode. This is encoded in game-theoretic terms through the notion of functional and finitary strategy. 

\begin{definition}\label{def:StratfunctionalFinitary}
Given a $\wmso$-automaton $\bbA = \tup{A,\tmap,\pmap,a_I}$ and transition system $\bbT$, a strategy $f$ for \eloise in $\mathcal{A}(\bbA,\model)$ is \emph{functional in $B \subseteq A$} (or simply functional, if $B=A$) if for each node $s$ in $\bbT$ there is at most one $b \in B$ such that $(b,s)$ is a reachable position in an $f$-guided match. Also $f$ is \emph{finitary} in $B$ if there are only finitely many nodes $s$ in $\bbT$ for which a position $(b,s)$ with $b \in B$ is reachable in an $f$-guided match.
\end{definition}



The next proposition establishes the desired properties of the finitary
construct.

\begin{proposition}[\textbf{Simulation Theorem for $\wmso$-automata}]\label{PROP_facts_finConstrwmso} Let $\aut$ be a $\wmso$-automaton and $\aut^{\fin}$ its finitary construct.
\begin{enumerate}[(i)]
  \itemsep 0 pt
  \item $\aut^{\fin}$ is a $\wmso$-automaton.\label{point:finConstrAut}
  \item For any $\model$, if $\exists$ has a winning strategy in $\agame(\aut^{\fin},\model)$ from position $(a_I^{\fin},s_I)$ then she has one that is functional in $\shA$ and finitary in $\shA$.% (\emph{cf.} Definition \ref{def:StratfunctionalFinitary}).
  \label{point:finConstrStrategy}
  \item $\aut \equiv \aut^{\fin}$. \label{point:finConstrEquiv}
  \end{enumerate}
\end{proposition}
\begin{proof}
\begin{enumerate}[(i)]
\item Observe that any SCC
of $\aut^{\fin}$ involves states of exactly one sort, either $A$ or $\shA$. For SCCs on sort $A$, \textbf{(weakness)} and \textbf{(continuity)} of $\aut^{\fin}$ follow by the ones of $\aut$. For SCCs on sort $\shA$, \textbf{(weakness)} follows by observing that all macro-states in $\aut^{\fin}$ have the same parity value. Concerning \textbf{(continuity)}, by definition of $\tmap^{\fin}$ any macro-state can only appear inside a formula of the form $\varphi^{\fin}$, which is by Lemma \ref{LEM_cont} is continuous in each $Q \in \shA$.
  \item  Let $f$ be a winning strategy for $\exists$ in $\mathcal{A}(\aut^{\fin},\model)@(a_I^{\fin},s_I)$. We define a strategy $f'$ for $\exists$ in the same game as follows:
      \begin{enumerate}[label=(\alph*),ref=\alph*]
        \item on basic positions of the form $(a,s) \in A\times T$, let $\val$ be the valuation suggested by $f$. We let the valuation suggested by $f'$ be the restriction $\val'$ of $\val$ to $A$. Observe that, as no predicate from $A^{\fin}\setminus A =\shA$ occurs in $\tmap^{\fin}(a,\V(s)) = \tmap(a,\V(s))$, then $\val'$ also makes that sentence true in $\R{s}$.
        \begin{comment} With minimality
        on basic positions of the form $(a,s) \in A\times T$, $f'$ is defined as $f$. Indeed, as no predicate from $\shA$ occurs in $\tmap^{\fin}(a,\V(s))$, we can assume that the valuation suggested by $f$ does not assign any of them to nodes in $\R{s}$.
        \end{comment}
        \label{point:stat2point1}
        \item for basic positions of the form $(R,s) \in \shA \times T$, let $\val_{R,s}$ be the valuation suggested by $f$. As $f$ is winning, $\tmap^{\fin}(R,\V(s))$ is true in the model $\val_{R,s}$. If this is because the disjunct $\bigwedge_{a \in \Ran(R)} \tmap(a,\V(s))$ is made true, then we can let $f'$ suggest the restriction to $A$ of $\val_{R,s}$, for the same reason as in \eqref{point:stat2point1}. Otherwise, the disjunct $\shDe(R,\V(s)) = \bigvee_{i}\varphi_i^{\fin}$ is made true. This means that, for some $i$,
             $$(R[s], \val_{R,s}) \models \varphi_i^{\fin}.$$
             By Lemma \ref{LEM_cont} $\varphi_i^{\fin}$ is functionally continuous in $\shA$, meaning that we have a restriction $\val_{R,s}'$ of $\val_{R,s}$ that verifies $\varphi_i^{\fin}$, assigns finitely many nodes to predicates from $\shA$ and associates with each node at most one predicate from $\shA$. We let $\val_{R,s}'$ be the suggestion of $f'$ from position $(R,s)$.
      \end{enumerate}
      The strategy $f'$ defined as above is immediately seen to be
      surviving for $\exists$. It is also winning, because the set of
      basic positions on which $f'$ is defined is a subset of the one
      of the winning strategy $f$. By this observation it also follows that any $f'$-conform match visits basic positions of the form $(R,s) \in \shA \times C$ only finitely many times, as those have odd parity. By definition, the valuation suggested by $f'$ only assigns finitely many nodes to predicates in $\shA$ from positions of that shape, and no nodes from other positions. It follows that $f'$ is finitary in $\shA$. Functionality in $\shA$ also follows immediately by definition of $f'$.
  \item For the direction from left to right, it is immediate by definition of $\aut^{\fin}$ that a winning strategy for $\exists$ in $\mc{G} = \mathcal{A}(\aut,\model)@(a_I,s_I)$ is also winning for $\exists$ in $\mc{G}^{\fin} = \mathcal{A}(\aut^{\fin},\model)@(a_I^{\fin},s_I)$.

      For the direction from right to left, let $f$ be a winning strategy for $\exists$ in $\mc{G}^{\fin}$. The idea is to define a strategy $f'$ for $\exists$ in stages, while playing a match $\pi'$ in $\mc{G}$. In parallel to $\pi'$, a shadow match $\pi$ in $\mc{G}^{\fin}$ is maintained, where $\exists$ plays according to the strategy $f$. For each round $z_i$, we want to keep the following relation between the two matches:
\smallskip
\begin{center}
\fbox{\parbox{12cm}{
Either
\begin{enumerate}[label=(\arabic*),ref=\arabic*]
  \item basic positions of the form $(Q,s) \in \shA \times T$ and $(a,s) \in A \times T$ occur respectively in $\pi$ and $\pi'$, with $a \in \Ran(Q)$,
\end{enumerate}
or
\begin{enumerate}[label=(\arabic*),ref=\arabic*]
  \item[(2)] the same basic position of the form $(a,s) \in A \times T$ occurs in both matches.
\end{enumerate}
}}\hspace*{0.3cm}($\ddag$)
\end{center}
\smallskip
The key observation is that, because $f$ is winning, a basic position of the form $(Q,s) \in \shA \times T$ can occur only for finitely many initial rounds $z_0,\dots,z_n$ that are played in $\pi$, whereas for all successive rounds $z_n,z_{n+1},\dots$ only basic positions of the form $(a,s) \in A \times T$ are encountered. Indeed, if this was not the case then either $\exists$ would get stuck or the minimum parity occurring infinitely often would be odd, since states from $\shA$ have parity $1$.

It follows that enforcing a relation between the two matches as in ($\ddag$) suffices to prove that the defined strategy $f'$ is winning for $\exists$ in $\pi'$. For this purpose, first observe that $(\ddag).1$ holds at the initial round, where the positions visited in $\pi'$ and $\pi$ are respectively $(a_I,s_I) \in A \times T$ and $(\{(a_I,a_I)\},s_I) \in A^{\fin} \times T$. Inductively, consider any round $z_i$ that is played in $\pi'$ and $\pi$, respectively with basic positions $(a,s) \in A \times T$ and $(q,s) \in A^{\fin} \times T$. In order to define the suggestion of $f'$ in $\pi'$, we distinguish two cases.
\begin{itemize}
  \item First suppose that $(q,s)$ is of the form $(Q,s) \in
  \shA\times T$. By ($\ddag$) we can assume that $a$ is in $\Ran(Q)$. Let $\val_{Q,s} :A^{\fin} \rightarrow \wp(\R{s})$ be the valuation suggested by $f$, verifying the sentence $\tmap^{\fin}(Q,\V(s))$. We distinguish two further cases, depending on which disjunct of $\tmap^{\fin}(Q,\V(s))$ is made true by $\val_{Q,s}$.
      \begin{enumerate}[label=(\roman*), ref=\roman*]
        \item If $(\R{s},\val_{Q,s})\models \bigwedge_{b \in \Ran(Q)} \tmap(b,\V(s))$, then we let $\exists$ pick the restriction to $A$ of the valuation $\val_{Q,s}$. \label{point:valuation1}
        \item If $(\R{s},\val_{Q,s})\models \shDe(Q,\V(s))$, we let $\exists$ pick a valuation $\val_{a,s}:A \rightarrow \p (\R{s})$ defined by putting, for each $b \in A$:
            \begin{align*}
            % \nonumber to remove numbering (before each equation)
               \val_{a,s}(b)\ :=\ \bigcup_{b \in \Ran(Q')} \{t \in \R{s} \mid t \in \val_{Q,s}(Q')\} 
               \cup  \{t \in \R{s} \mid t \in \val_{Q,s}(b)\} .
            \end{align*} \label{point:valuation2}
      \end{enumerate}
      It can be readily checked that the suggested move is admissible for $\exists$ in $\pi$, i.e. it makes $\tmap(a,\V(s))$ true in $\R{s}$. For case \eqref{point:valuation2}, one has to observe how $\shDe$ is defined in terms of $\tmap$. In particular, the nodes assigned to $b$ by $\val_{Q,s}$ have to be assigned to $b$ also by $\val_{a,s}$, as they may be necessary to fulfill the condition, expressed with $\qu$ and $\dqu$, that infinitely many nodes witness (or that finitely many nodes do not witness) some type.

      We now show that $(\ddag)$ holds at round $z_{i+1}$. If \eqref{point:valuation1} is the case, any next position $(b,t)\in A \times T$ picked by player $\forall$ in $\pi'$ is also available for $\forall$ in $\pi$, and we end up in case $(\ddag .2)$. Suppose instead that \eqref{point:valuation2} is the case. Given the choice $(b,t) \in A \times T$ of $\forall$, by definition of $\val_{a,s}$ there are two possibilities. First, $(b,t)$ is also an available choice for $\forall$ in $\pi$, and we end up in case $(\ddag .2)$ as before. Otherwise, there is some $Q' \in \shA$ such that $b$ is in $\Ran(Q')$ and $\forall$ can choose $(Q',t)$ in the shadow match $\pi$. By letting $\pi$ advance at round $z_{i+1}$ with such a move, we are able to maintain $(\ddag .1)$ also in $z_{i+1}$.
  \item In the remaining case, inductively we are given the same basic position $(a,s) \in A\times T$ both in $\pi$ and in $\pi'$. The valuation $\val$ suggested by $f$ in $\pi$ verifies $\tmap^{\fin}(a,\V(s)) = \tmap(a,\V(s))$, thus we can let the restriction of $\val$ to $A$ be the valuation chosen by $\exists$ in the match $\pi'$. It is immediate that any next move of $\forall$ in $\pi'$ can be mirrored by the same move in $\pi$, meaning that we are able to maintain the same position --whence the relation $(\ddag.1)$-- also in the next round.
\end{itemize}
In both cases, the suggestion of strategy $f'$ was a legitimate move for $\exists$ maintaining the relation $(\ddag)$ between the two matches for any next round $z_{i+1}$. It follows that $f'$ is a winning strategy for $\exists$ in $\mc{G}$.
\end{enumerate}
\end{proof}





\subsubsection{From formulae to automata}
\input{pauto/autchar.tex}

\subsubsection{From automata to formulae}
\input{pauto/autotowmso.tex}